{% extends "inventory/base.html" %}
{% block title %}Produits{% endblock %}
{% block content %}
<style>
    .product-grid { display: grid; gap: 0.9rem; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    .product-card {
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
        border: 1px solid var(--border-strong);
        border-radius: 16px;
        padding: 0.95rem 1rem;
        background: linear-gradient(180deg, #122540, #0b1629);
        text-decoration: none;
        color: var(--text);
        box-shadow: var(--shadow);
        transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .product-card:hover { transform: translateY(-2px); box-shadow: 0 12px 26px rgba(0, 198, 255, 0.24); border-color: rgba(77, 240, 255, 0.5); }
    .product-thumb {
        height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255,255,255,0.04);
        border: 1px dashed var(--border-strong);
        border-radius: 12px;
        overflow: hidden;
    }
    .product-thumb img { max-height: 110px; width: 100%; object-fit: contain; }
    .product-thumb .placeholder { font-size: 0.9rem; color: var(--muted); text-align: center; padding: 0 0.75rem; line-height: 1.4; }
    .product-meta h3 { margin: 0 0 0.1rem; font-size: 1rem; }
    .product-meta .sku { margin: 0; color: var(--muted); font-size: 0.85rem; }
    .product-footer { display: flex; justify-content: space-between; align-items: center; gap: 0.75rem; }
    .price { font-weight: 700; font-size: 1.05rem; color: var(--accent); }
    .price.muted { color: #c6d6f2; font-size: 0.95rem; font-weight: 600; }
    .stock { padding: 0.3rem 0.65rem; border-radius: 10px; font-weight: 700; font-size: 0.85rem; border: 1px solid transparent; }
    .stock.safe { background: rgba(110, 242, 166, 0.18); color: var(--success); border-color: rgba(110, 242, 166, 0.45); }
    .stock.warn { background: rgba(252, 179, 92, 0.16); color: var(--warning); border-color: rgba(252, 179, 92, 0.45); }
    .autocomplete-panel { position: relative; }
    .autocomplete-results {
        position: absolute;
        top: calc(100% + 6px);
        left: 0;
        right: 0;
        background: #0f172a;
        color: #e2e8f0;
        border: 1px solid var(--border-strong);
        border-radius: 10px;
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.25);
        z-index: 40;
        max-height: 320px;
        overflow-y: auto;
    }
    .autocomplete-option {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        border: none;
        background: transparent;
        padding: 0.7rem 0.9rem;
        cursor: pointer;
        text-align: left;
        color: inherit;
    }
    .autocomplete-option:hover,
    .autocomplete-option:focus { background: rgba(255,255,255,0.04); outline: none; }
    .autocomplete-empty { padding: 0.7rem 0.9rem; color: #cbd5e1; }
    .product-thumb {
        width: 42px;
        height: 42px;
        border-radius: 9px;
        background: #1b2b45;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        flex-shrink: 0;
        border: 1px solid var(--border-strong);
    }
    .product-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .product-thumb.fallback { font-weight: 700; color: #cbd5e1; }
</style>

<section class="page-header reveal">
    <div>
        <p class="eyebrow">Catalogue produits</p>
        <h1 class="page-title">Produits</h1>
        <p class="lead">Vue carte avec prix, stock, marque et site.</p>
        <div class="chip-row" style="margin-top:0.4rem;">
            <span class="pill">Total : {{ total_products }} produits</span>
            {% if search %}<span class="pill">Recherche : {{ search }}</span>{% endif %}
            {% if selected_brand %}
                {% for option in brands %}
                    {% if option.brand_id|stringformat:"s" == selected_brand %}
                        <span class="pill">Marque : {{ option.brand__name }}</span>
                    {% endif %}
                {% endfor %}
            {% endif %}
            {% if selected_category %}
                {% for option in categories %}
                    {% if option.category_id|stringformat:"s" == selected_category %}
                        <span class="pill">Catégorie : {{ option.category__name }}</span>
                    {% endif %}
                {% endfor %}
            {% endif %}
            {% if selected_site %}
                {% for site in sites %}
                    {% if selected_site == site.pk|stringformat:"s" %}
                        <span class="pill">Site : {{ site.name }}</span>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>
    </div>
    <div class="toolbar">
        <a class="btn secondary" href="{% url 'inventory:inventory_overview' %}">Vue tableau</a>
        <a class="btn secondary" href="{% url 'inventory:product_create' %}">+ Créer un produit</a>
        <a class="btn" href="{% url 'inventory:record_movement' %}">Mouvement stock</a>
    </div>
</section>

<section class="split split-70">
    <div class="stack">
        <div class="surface reveal" data-delay="100">
            <form method="get" class="form-grid" id="inventory-filter-form">
                <div class="field">
                    <label for="search">Recherche</label>
                    <div class="autocomplete-panel">
                        <input id="search" type="text" name="q" value="{{ search }}" placeholder="Nom, SKU ou référence" autocomplete="off">
                        <div class="autocomplete-results" data-search-results></div>
                    </div>
                </div>
                <div class="field">
                    <label for="brand">Marque</label>
                    <select id="brand" name="brand">
                        <option value="">Toutes</option>
                        {% for option in brands %}
                            <option value="{{ option.brand_id }}" {% if option.brand_id|stringformat:"s" == selected_brand %}selected{% endif %}>
                                {{ option.brand__name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="field">
                    <label for="category">Catégorie</label>
                    <select id="category" name="category">
                        <option value="">Toutes</option>
                        {% for option in categories %}
                            <option value="{{ option.category_id }}" {% if option.category_id|stringformat:"s" == selected_category %}selected{% endif %}>
                                {{ option.category__name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="field">
                    <label for="site">Site</label>
                    {% if can_switch_site %}
                        <select id="site" name="site">
                            <option value="" {% if not selected_site %}selected{% endif %}>Vue globale</option>
                            {% for site in sites %}
                                <option value="{{ site.pk }}" {% if selected_site == site.pk|stringformat:"s" %}selected{% endif %}>{{ site.name }}</option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <div class="context-chip" style="width:100%;">{{ active_site.name|default:"Vue globale" }}</div>
                    {% endif %}
                </div>
                <div class="field">
                    <label for="sort">Tri</label>
                    <select id="sort" name="sort">
                        <option value="name" {% if selected_sort == "name" %}selected{% endif %}>Nom (A→Z)</option>
                        <option value="price_asc" {% if selected_sort == "price_asc" %}selected{% endif %}>Prix croissant</option>
                        <option value="price_desc" {% if selected_sort == "price_desc" %}selected{% endif %}>Prix décroissant</option>
                        <option value="stock_desc" {% if selected_sort == "stock_desc" %}selected{% endif %}>Stock le plus élevé</option>
                        <option value="newest" {% if selected_sort == "newest" %}selected{% endif %}>Nouveautés</option>
                    </select>
                </div>
                <div class="field">
                    <label for="page_size">Résultats par page</label>
                    <select id="page_size" name="page_size">
                        {% for size in allowed_page_sizes %}
                            <option value="{{ size }}" {% if size == page_size %}selected{% endif %}>{{ size }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="field" style="align-self:flex-end;">
                    <div class="toolbar">
                        <button type="submit" class="btn">Filtrer</button>
                        <a class="btn secondary" href="{% url 'inventory:inventory_overview' %}">Réinitialiser</a>
                    </div>
                    <p class="muted-text" style="margin:0.35rem 0 0; font-size:0.9rem;">
                        Les champs vides sont ignorés pour des requêtes plus légères.
                    </p>
                </div>
            </form>
        </div>

        <div class="surface reveal" data-delay="160">
            <div class="product-grid">
                {% for product in products %}
                    <a class="product-card reveal pulse-border" data-delay="{% widthratio forloop.counter 1 30 %}" href="{% url 'inventory:product_detail' product.pk %}">
                        <div class="product-thumb">
                            {% if product.image %}
                                <img src="{{ product.image.url }}" alt="Image de {{ product.name }}" loading="lazy">
                            {% else %}
                                <div class="placeholder">{{ product.sku|default:"SKU en attente" }}</div>
                            {% endif %}
                        </div>
                        <div class="product-meta">
                            <div class="chip-row">
                                <span class="tag">★ {{ product.brand.name }}</span>
                                <span class="tag">{{ product.category.name }}</span>
                            </div>
                            <h3>{{ product.name }}</h3>
                            <p class="product-meta sku">{{ product.sku }}</p>
                        </div>
                        <div class="product-footer">
                            {% if product.sale_price %}
                                <div class="price">{{ product.sale_price|floatformat:0 }} FCFA</div>
                            {% else %}
                                <div class="price muted">Prix non défini</div>
                            {% endif %}
                            {% if product.is_below_minimum %}
                                <div class="stock warn">{{ product.stock_quantity }} / min {{ product.minimum_stock }}</div>
                            {% else %}
                                <div class="stock safe">{{ product.stock_quantity }} en stock</div>
                            {% endif %}
                        </div>
                        {% if product.site_stocks %}
                            <div class="muted-text" style="margin-top:0.5rem;font-size:0.9rem;">
                                {% for site_stock in product.site_stocks %}
                                    <div style="display:flex;justify-content:space-between;gap:0.75rem;">
                                        <span>{{ site_stock.site_name }}</span>
                                        <span style="font-weight:600;">{{ site_stock.quantity }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </a>
                {% empty %}
                    <p class="muted-text" style="margin:0;">Aucun produit trouvé.</p>
                {% endfor %}
            </div>
            {% if page_obj.has_other_pages %}
                <nav class="pagination" style="display:flex; justify-content:space-between; align-items:center; margin-top:1rem; flex-wrap:wrap; gap:0.5rem;">
                    {% if page_obj.has_previous %}
                        <a class="btn secondary" href="{% if pagination_query %}?{{ pagination_query }}&page={{ page_obj.previous_page_number }}{% else %}?page={{ page_obj.previous_page_number }}{% endif %}">Précédent</a>
                    {% else %}
                        <span></span>
                    {% endif %}
                    <span class="muted-text">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
                    {% if page_obj.has_next %}
                        <a class="btn secondary" href="{% if pagination_query %}?{{ pagination_query }}&page={{ page_obj.next_page_number }}{% else %}?page={{ page_obj.next_page_number }}{% endif %}">Suivant</a>
                    {% endif %}
                </nav>
            {% endif %}
        </div>
    </div>

    <div class="stack">
        <div class="surface reveal" data-delay="120">
            <p class="eyebrow">Scan rapide</p>
            <h3 class="surface-title" style="margin-bottom:0.35rem;">Trouver ou créer un produit</h3>
            <form method="get" class="stack">
                {% if search %}<input type="hidden" name="q" value="{{ search }}">{% endif %}
                {% if selected_brand %}<input type="hidden" name="brand" value="{{ selected_brand }}">{% endif %}
                {% if selected_category %}<input type="hidden" name="category" value="{{ selected_category }}">{% endif %}
                {% if selected_site %}<input type="hidden" name="site" value="{{ selected_site }}">{% endif %}
                <label for="scan">Scan (SKU ou code-barres)</label>
                <div class="autocomplete-panel">
                    <input id="scan" type="text" name="scan" placeholder="Scannez ici pour isoler un produit" autocomplete="off" autofocus>
                    <div class="autocomplete-results" data-scan-results></div>
                </div>
                <div class="muted-text" style="font-size:0.85rem;">Le champ se réinitialise après chaque scan. Appuyez sur Entrée si besoin.</div>
            </form>
            {% if scan_message %}
                <p style="color:var(--accent); margin-top:0.5rem;">{{ scan_message }}</p>
            {% endif %}
        </div>

        <div class="surface reveal" data-delay="180">
            <p class="eyebrow">Ajustement rapide</p>
            <h3 class="surface-title" style="margin-bottom:0.35rem;">Mettre à jour le stock</h3>
            <p class="muted-text" style="margin-top:0; margin-bottom:0.75rem; font-size:0.9rem;">
                Site actif : <strong>{{ active_site.name|default:"Vue globale" }}</strong>
            </p>
            <form method="post" class="stack">
                {% csrf_token %}
                <div class="form-grid">
                    <div class="field">
                        <label for="{{ adjustment_form.product.id_for_label }}">{{ adjustment_form.product.label }}</label>
                        {{ adjustment_form.product }}
                        {{ adjustment_form.product.errors }}
                    </div>
                    <div class="field">
                        <label for="{{ adjustment_form.counted_quantity.id_for_label }}">{{ adjustment_form.counted_quantity.label }}</label>
                        {{ adjustment_form.counted_quantity }}
                        {{ adjustment_form.counted_quantity.errors }}
                    </div>
                    {% if can_switch_site %}
                        <div class="field">
                            <label for="{{ adjustment_form.site.id_for_label }}">{{ adjustment_form.site.label }}</label>
                            {{ adjustment_form.site }}
                            {{ adjustment_form.site.errors }}
                        </div>
                    {% endif %}
                </div>
                <div class="field">
                    <label for="{{ adjustment_form.comment.id_for_label }}">{{ adjustment_form.comment.label }}</label>
                    {{ adjustment_form.comment }}
                    {{ adjustment_form.comment.errors }}
                </div>
                {% if not can_switch_site %}
                    {{ adjustment_form.site }}
                {% endif %}
                <div style="margin-top:0.5rem;">
                    <button type="submit" class="btn">Enregistrer l'ajustement</button>
                </div>
            </form>
        </div>
    </div>
</section>
{{ product_dataset|json_script:"product-dataset" }}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const productDataset = JSON.parse(document.getElementById("product-dataset").textContent || "[]");
    const searchInput = document.getElementById("search");
    const scanInput = document.getElementById("scan");
    const searchResults = document.querySelector("[data-search-results]");
    const scanResults = document.querySelector("[data-scan-results]");
    const filterForm = document.getElementById("inventory-filter-form");

    const createThumb = (item) => {
        const thumb = document.createElement("div");
        thumb.className = "product-thumb";
        if (item && item.image_url) {
            const img = document.createElement("img");
            img.src = item.image_url;
            img.alt = item.name || "Produit";
            thumb.appendChild(img);
        } else {
            thumb.classList.add("fallback");
            thumb.textContent = (item?.name || "?").slice(0, 1).toUpperCase();
        }
        return thumb;
    };

    const filterProducts = (value) => {
        const normalized = (value || "").toLowerCase().trim();
        if (!normalized) return [];
        return productDataset
            .filter((p) =>
                (p.name || "").toLowerCase().includes(normalized) ||
                (p.sku || "").toLowerCase().includes(normalized) ||
                (p.barcode || "").toLowerCase().includes(normalized)
            )
            .slice(0, 10);
    };

    const renderOptions = (input, container, onSelect) => {
        if (!container) return;
        const matches = filterProducts(input.value);
        container.innerHTML = "";
        if (!matches.length) {
            const empty = document.createElement("div");
            empty.className = "autocomplete-empty";
            empty.textContent = "Aucun produit";
            container.appendChild(empty);
            return;
        }
        matches.forEach((item) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "autocomplete-option";
            btn.appendChild(createThumb(item));
            const meta = document.createElement("div");
            const title = document.createElement("div");
            title.textContent = item.name;
            title.style.fontWeight = "700";
            const subtitle = document.createElement("div");
            subtitle.textContent = item.sku || item.barcode || "Sans référence";
            subtitle.style.color = "var(--muted)";
            meta.append(title, subtitle);
            btn.appendChild(meta);
            btn.addEventListener("mousedown", (e) => e.preventDefault());
            btn.addEventListener("click", () => onSelect(item));
            container.appendChild(btn);
        });
    };

    if (searchInput) {
        const selectSearch = (item) => {
            searchInput.value = item.name;
            if (filterForm) {
                filterForm.submit();
            }
        };
        searchInput.addEventListener("input", () => renderOptions(searchInput, searchResults, selectSearch));
        searchInput.addEventListener("focus", () => renderOptions(searchInput, searchResults, selectSearch));
        searchInput.addEventListener("blur", () => setTimeout(() => searchResults && (searchResults.innerHTML = ""), 150));
    }

    if (scanInput) {
        const selectScan = (item) => {
            scanInput.value = item.barcode || item.sku || item.name;
            const parentForm = scanInput.closest("form");
            if (parentForm) parentForm.submit();
        };
        scanInput.addEventListener("input", () => renderOptions(scanInput, scanResults, selectScan));
        scanInput.addEventListener("focus", () => renderOptions(scanInput, scanResults, selectScan));
        scanInput.addEventListener("blur", () => setTimeout(() => scanResults && (scanResults.innerHTML = ""), 150));
    }
});
</script>
<script>
    (() => {
        const form = document.getElementById("inventory-filter-form");
        if (!form) return;

        form.addEventListener("submit", () => {
            const fields = form.querySelectorAll("input[name], select[name]");
            fields.forEach((field) => {
                if (field instanceof HTMLInputElement && field.type === "text") {
                    field.value = field.value.trim();
                }
                if (field.value === "") {
                    field.disabled = true;
                }
            });
        });
    })();
</script>
{% endblock %}

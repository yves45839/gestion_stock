{% extends "inventory/base.html" %}
{% block title %}Inventaire physique{% endblock %}
{% block content %}
<section class="page-header">
    <div>
        <p class="eyebrow">Inventaire</p>
        <h1 class="page-title">Inventaire physique</h1>
        <p class="lead">Comptage complet des articles par site, écarts et démarques.</p>
        <div class="chip-row" style="margin-top:0.5rem;">
            <span class="pill">Session : {{ session.name }}</span>
            <span class="pill">Site : {{ current_site.name|default:"-" }}</span>
            <span class="pill">Statut : {{ session.get_status_display }}</span>
            {% if session.closed_at %}<span class="pill">Clôturé le {{ session.closed_at|date:"d/m/Y H:i" }}</span>{% endif %}
        </div>
    </div>
    <div class="toolbar">
        <a class="btn secondary" href="{% url 'inventory:inventory_overview' %}">Retour produits</a>
    </div>
</section>

<div class="surface" style="margin-bottom:0.75rem;">
    <form method="get" class="toolbar" style="gap:0.75rem; flex-wrap:wrap;">
        <div style="flex:1; min-width:260px;">
            <label class="eyebrow" for="search">Rechercher un produit ou une référence</label>
            <div class="autocomplete-panel">
                <input id="search" name="q" type="search" value="{{ search }}" placeholder="Nom, SKU, code-barres, marque, catégorie" style="width:100%;" autocomplete="off" />
                <div class="autocomplete-results" data-search-results></div>
            </div>
        </div>
        <label style="display:flex; align-items:center; gap:0.4rem; margin-top:1.4rem;">
            <input type="checkbox" name="diff_only" value="1" {% if show_only_differences %}checked{% endif %} />
            <span>Uniquement les écarts</span>
        </label>
        <button type="submit" class="btn secondary" style="margin-top:1.1rem;">Appliquer les filtres</button>
    </form>
    <div class="chip-row" style="margin-top:0.5rem;">
        <span class="pill">{{ lines|length }} ligne(s) affichée(s) sur {{ total_lines }}</span>
        <span class="pill">Écarts filtrés : {{ totals.total_difference }} | Démarque filtrée : {{ totals.total_loss }} FCFA</span>
        {% if totals.total_difference != overall_totals.total_difference or totals.total_loss != overall_totals.total_loss %}
            <span class="pill muted-text">Inventaire complet : {{ overall_totals.total_difference }} écart(s), {{ overall_totals.total_loss }} FCFA</span>
        {% endif %}
    </div>
</div>

<div class="surface" style="overflow-x:auto;">
    <form method="post">
        {% csrf_token %}
        <table>
            <thead>
                <tr>
                    <th style="min-width:220px;">Produit</th>
                    <th>Attendu</th>
                    <th>Compté</th>
                    <th>Écart</th>
                    <th>Démarque</th>
                </tr>
            </thead>
            <tbody>
                {% for line in lines %}
                    <tr>
                        <td>
                            <div style="font-weight:700;">{{ line.product.name }}</div>
                            <div class="muted-text" style="font-size:0.9rem;">{{ line.product.sku }} · {{ line.product.brand.name }} / {{ line.product.category.name }}</div>
                        </td>
                        <td>{{ line.expected_qty }}</td>
                        <td>
                            {% if session.is_closed %}
                                {{ line.counted_qty }}
                            {% else %}
                                <input type="number" name="counted_{{ line.id }}" value="{{ line.counted_qty }}" min="0" style="width:110px;" />
                            {% endif %}
                        </td>
                        <td>
                            {% if line.difference < 0 %}
                                <span style="color:var(--danger); font-weight:700;">{{ line.difference }}</span>
                            {% elif line.difference > 0 %}
                                <span style="color:var(--success); font-weight:700;">+{{ line.difference }}</span>
                            {% else %}
                                <span class="muted-text">0</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if line.value_loss and line.value_loss > 0 %}
                                <span style="color:var(--danger); font-weight:700;">-{{ line.value_loss }} FCFA</span>
                            {% else %}
                                <span class="muted-text">0</span>
                            {% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="5" class="muted-text">Aucun produit à inventorier.</td></tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="surface" style="margin-top:0.75rem; display:flex; justify-content:space-between; align-items:center; gap:1rem;">
            <div>
                <div class="eyebrow" style="margin-bottom:0.2rem;">Synthèse</div>
                <div class="chip-row">
                    <span class="pill">Total écarts : {{ totals.total_difference }}</span>
                    <span class="pill">Démarque estimée : {{ totals.total_loss }} FCFA</span>
                    <span class="pill">Lignes : {{ lines|length }}</span>
                </div>
            </div>
            {% if not session.is_closed %}
                <div class="toolbar">
                    <button type="submit" name="action" value="save" class="btn secondary">Enregistrer</button>
                    <button type="submit" name="action" value="close" class="btn">Clôturer et générer les ajustements</button>
                </div>
            {% endif %}
        </div>
    </form>
</div>
{{ product_dataset|json_script:"inventory-product-dataset" }}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const productDataset = JSON.parse(document.getElementById("inventory-product-dataset").textContent || "[]");
    const searchInput = document.getElementById("search");
    const searchResults = document.querySelector("[data-search-results]");

    const filterProducts = (value) => {
        const normalized = (value || "").toLowerCase().trim();
        if (!normalized) return [];
        return productDataset
            .filter((p) =>
                (p.name || "").toLowerCase().includes(normalized) ||
                (p.sku || "").toLowerCase().includes(normalized) ||
                (p.barcode || "").toLowerCase().includes(normalized) ||
                (p.brand || "").toLowerCase().includes(normalized) ||
                (p.category || "").toLowerCase().includes(normalized)
            )
            .slice(0, 8);
    };

    const renderOptions = () => {
        if (!searchResults || !searchInput) return;
        const matches = filterProducts(searchInput.value);
        searchResults.innerHTML = "";
        if (!matches.length) {
            const empty = document.createElement("div");
            empty.className = "autocomplete-empty";
            empty.textContent = "Aucun produit";
            searchResults.appendChild(empty);
            return;
        }
        matches.forEach((item) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "autocomplete-option";
            const title = document.createElement("div");
            title.textContent = item.name;
            title.style.fontWeight = "700";
            const subtitle = document.createElement("div");
            subtitle.textContent = item.sku || item.barcode || item.brand || item.category || "Sans référence";
            subtitle.style.color = "var(--muted)";
            btn.append(title, subtitle);
            btn.addEventListener("mousedown", (e) => e.preventDefault());
            btn.addEventListener("click", () => {
                searchInput.value = item.name;
                const form = searchInput.closest("form");
                if (form) form.submit();
            });
            searchResults.appendChild(btn);
        });
    };

    if (searchInput) {
        searchInput.addEventListener("input", renderOptions);
        searchInput.addEventListener("focus", renderOptions);
        searchInput.addEventListener("blur", () => setTimeout(() => searchResults && (searchResults.innerHTML = ""), 150));
    }
});
</script>
{% endblock %}

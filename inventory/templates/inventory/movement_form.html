{% extends "inventory/base.html" %}
{% block title %}Nouveau mouvement{% endblock %}
{% block content %}
<section class="card" style="max-width:900px;margin:0 auto;display:flex;flex-direction:column;gap:1.5rem;">
    <style>
        .product-select { display: none; }
        .autocomplete-panel { position: relative; }
        .autocomplete-results {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 6px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            z-index: 20;
            max-height: 260px;
            overflow-y: auto;
        }
        .autocomplete-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            border: none;
            background: transparent;
            padding: 0.65rem 0.85rem;
            cursor: pointer;
            text-align: left;
        }
        .autocomplete-option:hover,
        .autocomplete-option:focus {
            background: #f7f7f7;
            outline: none;
        }
        .autocomplete-empty {
            padding: 0.65rem 0.85rem;
            color: var(--muted);
        }
        .product-thumb {
            width: 42px;
            height: 42px;
            border-radius: 8px;
            background: #f3f4f6;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
            border: 1px solid var(--border);
        }
        .product-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .product-thumb.fallback {
            font-weight: 600;
            color: #6b7280;
        }
        .product-preview {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 0.35rem;
            color: var(--muted);
        }
        .product-preview strong {
            color: inherit;
            display: block;
        }
    </style>
    <div>
        <h2 style="margin-top:0;">Mode scanner</h2>
        <p style="color:var(--muted);margin-bottom:0.5rem;">Scannez un code-barres pour sélectionner automatiquement le produit et incrémenter la quantité.</p>
        <div style="display:flex;gap:1rem;align-items:center;">
            <input id="scan-input" type="text" placeholder="Prêt pour scan..." class="form-control" style="max-width:320px;" data-lookup-url="{% url 'inventory:lookup_product' %}">
            <button type="button" class="btn secondary" id="scan-reset">Réinitialiser</button>
        </div>
        <div id="scan-summary" style="margin-top:0.75rem;font-size:0.9rem;color:var(--muted);">En attente d'un premier scan.</div>
        <ul id="scan-history" style="list-style:none;padding-left:0;margin:0;color:var(--muted);font-size:0.85rem;"></ul>
    </div>
    <h2>Enregistrer un mouvement</h2>
    <form method="post" novalidate id="movement-form">
        {% csrf_token %}
        <div style="margin-bottom:1rem;font-size:0.9rem;color:var(--muted);">
            Site actif :
            <strong>{{ active_site.name|default:"Vue globale" }}</strong>
        </div>
        {% if header_form.non_field_errors %}
            <div class="alert alert-error">{{ header_form.non_field_errors }}</div>
        {% endif %}
        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;">
            <div>
                <label for="{{ header_form.movement_type.id_for_label }}">{{ header_form.movement_type.label }}</label>
                {{ header_form.movement_type }}
                {{ header_form.movement_type.errors }}
            </div>
            <div>
                <label for="{{ header_form.site.id_for_label }}">{{ header_form.site.label }}</label>
                {{ header_form.site }}
                {{ header_form.site.errors }}
            </div>
            <div>
                <label for="{{ header_form.movement_date.id_for_label }}">{{ header_form.movement_date.label }}</label>
                {{ header_form.movement_date }}
                {{ header_form.movement_date.errors }}
            </div>
        </div>
        <div style="margin-top:1rem;">
            <label for="{{ header_form.document_number.id_for_label }}">{{ header_form.document_number.label }}</label>
            {{ header_form.document_number }}
            {{ header_form.document_number.errors }}
        </div>
        <div style="margin-top:1rem;">
            <label for="{{ header_form.comment.id_for_label }}">{{ header_form.comment.label }}</label>
            {{ header_form.comment }}
            {{ header_form.comment.errors }}
        </div>
        <div style="margin-top:1.5rem;">
            <h3 style="margin:0 0 0.5rem 0;">Produits</h3>
            {{ line_formset.management_form }}
            <div id="movement-lines" style="display:flex;flex-direction:column;gap:1rem;">
                {% for form in line_formset %}
                    <div class="movement-line card" style="padding:1rem;">
                        {% if form.non_field_errors %}
                            <div class="alert alert-error">{{ form.non_field_errors }}</div>
                        {% endif %}
                        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;align-items:end;">
                            <div>
                                <label for="{{ form.product.id_for_label }}">{{ form.product.label }}</label>
                                <div class="autocomplete-panel">
                                    <input type="text" class="form-control product-search" placeholder="Chercher un produit par nom ou référence" autocomplete="off">
                                    {{ form.product }}
                                    <div class="autocomplete-results" data-autocomplete></div>
                                </div>
                                <div class="product-preview" data-product-preview>
                                    <div class="product-thumb fallback">?</div>
                                    <div>
                                        <strong>Aucun produit sélectionné</strong>
                                        <small style="color:var(--muted);">Saisissez un nom ou une référence pour commencer.</small>
                                    </div>
                                </div>
                                {{ form.product.errors }}
                            </div>
                            <div>
                                <label for="{{ form.quantity.id_for_label }}">{{ form.quantity.label }}</label>
                                {{ form.quantity }}
                                {{ form.quantity.errors }}
                            </div>
                            {% if line_formset.can_delete %}
                                <div style="display:flex;align-items:center;gap:0.5rem;">
                                    <label style="margin:0;">Supprimer</label>
                                    {{ form.DELETE }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div style="margin-top:0.75rem;">
                <button type="button" class="btn secondary" id="add-line">Ajouter une ligne produit</button>
            </div>
        </div>
        <div style="margin-top:1.5rem;display:flex;gap:1rem;flex-wrap:wrap;align-items:center;">
            <button type="submit" class="btn">Enregistrer</button>
            <a href="{% url 'inventory:dashboard' %}" class="btn secondary">Annuler</a>
        </div>
        <template id="line-template">
            <div class="movement-line card" style="padding:1rem;">
                <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;align-items:end;">
                    <div>
                        <label>Produit</label>
                        <div class="autocomplete-panel">
                            <input type="text" class="form-control product-search" placeholder="Chercher un produit par nom ou référence" autocomplete="off">
                            __PRODUCT__
                            <div class="autocomplete-results" data-autocomplete></div>
                        </div>
                        <div class="product-preview" data-product-preview>
                            <div class="product-thumb fallback">?</div>
                            <div>
                                <strong>Aucun produit sélectionné</strong>
                                <small style="color:var(--muted);">Saisissez un nom ou une référence pour commencer.</small>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label>Quantité</label>
                        __QUANTITY__
                    </div>
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                        <label style="margin:0;">Supprimer</label>
                        __DELETE__
                    </div>
                </div>
            </div>
        </template>
        <div id="empty-form" style="display:none;">{{ line_formset.empty_form }}</div>
    </form>
</section>
{{ product_dataset|json_script:"product-dataset" }}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const scanInput = document.getElementById("scan-input");
        const resetBtn = document.getElementById("scan-reset");
        const summary = document.getElementById("scan-summary");
        const historyList = document.getElementById("scan-history");
        const productSelects = () => Array.from(document.querySelectorAll(".product-select"));
        const quantityInputs = () => Array.from(document.querySelectorAll(".quantity-input"));
        const history = [];
        const totalFormsInput = document.getElementById("id_lines-TOTAL_FORMS");
        const lineTemplate = document.getElementById("line-template");
        const addLineBtn = document.getElementById("add-line");
        const linesContainer = document.getElementById("movement-lines");
        const emptyForm = document.getElementById("empty-form");
        const productDataset = JSON.parse(document.getElementById("product-dataset").textContent || "[]");

        const createThumb = (product) => {
            const thumb = document.createElement("div");
            thumb.className = "product-thumb";
            if (product && product.image_url) {
                const img = document.createElement("img");
                img.src = product.image_url;
                img.alt = product.name || "Produit";
                thumb.appendChild(img);
            } else {
                thumb.classList.add("fallback");
                thumb.textContent = (product?.name || "?").slice(0, 1).toUpperCase();
            }
            return thumb;
        };

        const renderPreview = (wrapper, product) => {
            if (!wrapper) return;
            wrapper.innerHTML = "";
            const thumb = createThumb(product);
            const info = document.createElement("div");
            const title = document.createElement("strong");
            title.textContent = product ? product.name : "Aucun produit sélectionné";
            const subtitle = document.createElement("small");
            subtitle.style.color = "var(--muted)";
            subtitle.textContent = product
                ? product.sku || "Référence manquante"
                : "Saisissez un nom ou une référence pour commencer.";
            info.append(title, subtitle);
            wrapper.append(thumb, info);
        };

        const bindAutocomplete = (lineElement) => {
            const searchInput = lineElement.querySelector(".product-search");
            const select = lineElement.querySelector(".product-select");
            const results = lineElement.querySelector("[data-autocomplete]");
            const preview = lineElement.querySelector("[data-product-preview]");
            renderPreview(
                preview,
                productDataset.find((p) => p.id.toString() === (select?.value || "")) || null,
            );

            const selectProduct = (product) => {
                if (!product || !select) return;
                ensureOptionExists(product);
                select.value = product.id.toString();
                if (searchInput) {
                    searchInput.value = `${product.name} (${product.sku || "Réf. inconnue"})`;
                }
                renderPreview(preview, product);
                if (results) {
                    results.innerHTML = "";
                }
            };

            const filterProducts = (term) => {
                const normalized = term.trim().toLowerCase();
                if (!normalized) return [];
                return productDataset
                    .filter(
                        (product) =>
                            (product.name || "").toLowerCase().includes(normalized) ||
                            (product.sku || "").toLowerCase().includes(normalized),
                    )
                    .slice(0, 8);
            };

            const renderResults = (items) => {
                if (!results) return;
                results.innerHTML = "";
                if (!items.length) {
                    const empty = document.createElement("div");
                    empty.className = "autocomplete-empty";
                    empty.textContent = "Aucun produit trouvé";
                    results.appendChild(empty);
                    return;
                }
                items.forEach((product) => {
                    const option = document.createElement("button");
                    option.type = "button";
                    option.className = "autocomplete-option";
                    option.appendChild(createThumb(product));
                    const meta = document.createElement("div");
                    const title = document.createElement("div");
                    title.textContent = product.name;
                    title.style.fontWeight = "600";
                    const subtitle = document.createElement("div");
                    subtitle.textContent = product.sku || "Sans référence";
                    subtitle.style.color = "var(--muted)";
                    meta.append(title, subtitle);
                    option.appendChild(meta);
                    option.addEventListener("click", () => selectProduct(product));
                    results.appendChild(option);
                });
            };

            if (searchInput) {
                searchInput.addEventListener("input", () => {
                    const matches = filterProducts(searchInput.value);
                    renderResults(matches);
                });
                searchInput.addEventListener("focus", () => {
                    const matches = filterProducts(searchInput.value);
                    renderResults(matches);
                });
                searchInput.addEventListener("blur", () => {
                    setTimeout(() => results && (results.innerHTML = ""), 150);
                });
            }
            if (select) {
                select.addEventListener("change", () => {
                    const product = productDataset.find((p) => p.id.toString() === select.value);
                    renderPreview(preview, product || null);
                });
            }
        };

        if (!scanInput) {
            return;
        }

        const focusScan = () => {
            scanInput.focus();
            scanInput.select();
        };

        const renderHistory = () => {
            historyList.innerHTML = "";
            history.slice(-5).reverse().forEach((entry) => {
                const li = document.createElement("li");
                li.textContent = `${entry.time} - ${entry.name} (${entry.sku})`;
                historyList.appendChild(li);
            });
        };

        const ensureOptionExists = (product) => {
            productSelects().forEach((select) => {
                let option = select.querySelector(`option[value="${product.id}"]`);
                if (!option) {
                    option = document.createElement("option");
                    option.value = product.id;
                    option.textContent = `${product.sku} - ${product.name}`;
                    select.appendChild(option);
                }
            });
        };

        const getCurrentLine = () => {
            const selects = productSelects();
            if (selects.length === 0) {
                return { productSelect: null, quantityInput: null };
            }
            const productSelect = selects[selects.length - 1];
            const quantityInput = quantityInputs()[quantityInputs().length - 1];
            return { productSelect, quantityInput };
        };

        const handleSuccess = (product, meta = {}) => {
            ensureOptionExists(product);
            const { productSelect, quantityInput } = getCurrentLine();
            if (productSelect) {
                const previous = productSelect.value;
                productSelect.value = product.id.toString();
                if (quantityInput) {
                    const current = parseInt(quantityInput.value || "0", 10) || 0;
                    if (previous === product.id.toString()) {
                        quantityInput.value = current + 1;
                    } else {
                        quantityInput.value = Math.max(current, 1) || 1;
                    }
                }
            }
            if (meta.created) {
                summary.textContent = `Nouveau produit créé : ${product.name} (${product.sku}). Pensez à enregistrer le mouvement pour initialiser le stock.`;
            } else {
                summary.textContent = `Sélection : ${product.name} (${product.sku}) - Stock actuel ${product.stock_quantity}`;
            }
            summary.style.color = meta.created ? "#047857" : "var(--muted)";
            history.push({
                name: product.name,
                sku: product.sku,
                time: new Date().toLocaleTimeString(),
            });
            renderHistory();
            document.querySelectorAll(".movement-line").forEach((line) => {
                const select = line.querySelector(".product-select");
                const preview = line.querySelector("[data-product-preview]");
                if (select && select.value === product.id.toString()) {
                    renderPreview(preview, product);
                }
            });
        };

        const handleError = (message) => {
            summary.textContent = message;
            summary.style.color = "#b91c1c";
            setTimeout(() => {
                summary.style.color = "var(--muted)";
            }, 2000);
        };

        const lookupProduct = (value) => {
            const url = new URL(scanInput.dataset.lookupUrl, window.location.origin);
            url.searchParams.set("code", value);
            fetch(url)
                .then((response) => response.json())
                .then((payload) => {
                    if (payload.found) {
                        handleSuccess(payload.product, { created: payload.created });
                    } else {
                        handleError(payload.error || "Produit introuvable");
                    }
                })
                .catch(() => handleError("Erreur réseau lors de la recherche."));
        };

        scanInput.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                const value = scanInput.value.trim();
                if (!value) {
                    return;
                }
                lookupProduct(value);
                scanInput.value = "";
            }
        });

        resetBtn.addEventListener("click", () => {
            history.splice(0, history.length);
            renderHistory();
            summary.textContent = "Historique réinitialisé.";
            quantityInputs().forEach((input) => (input.value = ""));
            productSelects().forEach((select) => (select.value = ""));
            focusScan();
        });

        const addLine = () => {
            if (!lineTemplate || !totalFormsInput || !emptyForm) {
                return;
            }
            const formIndex = parseInt(totalFormsInput.value, 10) || 0;
            const templateHtml = emptyForm.innerHTML.replace(/__prefix__/g, formIndex);
            const wrapper = document.createElement("div");
            wrapper.innerHTML = templateHtml;
            const productField = wrapper.querySelector("select");
            const quantityField = wrapper.querySelector("input[type='number']");
            const deleteField = wrapper.querySelector("input[name$='-DELETE']");
            let lineHtml = lineTemplate.innerHTML;
            lineHtml = lineHtml.replace("__PRODUCT__", productField.outerHTML);
            lineHtml = lineHtml.replace("__QUANTITY__", quantityField.outerHTML);
            lineHtml = lineHtml.replace("__DELETE__", deleteField ? deleteField.outerHTML : "");
            const lineWrapper = document.createElement("div");
            lineWrapper.innerHTML = lineHtml;
            const newLine = lineWrapper.firstElementChild;
            linesContainer.appendChild(newLine);
            totalFormsInput.value = formIndex + 1;
            bindAutocomplete(newLine);
        };

        Array.from(document.querySelectorAll(".movement-line")).forEach((line) => {
            bindAutocomplete(line);
        });

        if (addLineBtn) {
            addLineBtn.addEventListener("click", addLine);
        }

        focusScan();
    });
</script>
{% endblock %}

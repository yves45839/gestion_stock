{% extends "inventory/base.html" %}
{% block title %}Mouvement de stock{% endblock %}
{% block content %}
<div class="card" style="margin-bottom:1.5rem;">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;">
        <div>
            <h1 style="margin:0;font-size:1.5rem;">Nouveau mouvement</h1>
            <p style="margin:0.25rem 0 0;color:var(--muted);">Sélectionnez le type, le site puis ajoutez vos lignes produit.</p>
        </div>
        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;justify-content:flex-end;">
            <a href="{% url 'inventory:product_create' %}" class="btn secondary">+ Créer un produit</a>
            <a href="{% url 'inventory:dashboard' %}" class="btn secondary">Retour</a>
        </div>
    </div>
</div>

<form method="post" id="movement-form" class="card" style="display:grid;gap:1rem;padding:1rem;">
    {% csrf_token %}
    {% if header_form.non_field_errors %}
        <div class="message error">{{ header_form.non_field_errors }}</div>
    {% endif %}
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:1rem;">
        <div>
            <label for="{{ header_form.movement_type.id_for_label }}">{{ header_form.movement_type.label }}</label>
            {{ header_form.movement_type }}
            {{ header_form.movement_type.errors }}
        </div>
        <div>
            <label for="{{ header_form.site.id_for_label }}">{{ header_form.site.label }}</label>
            {{ header_form.site }}
            {{ header_form.site.errors }}
        </div>
        <div>
            <label for="{{ header_form.movement_date.id_for_label }}">{{ header_form.movement_date.label }}</label>
            {{ header_form.movement_date }}
            {{ header_form.movement_date.errors }}
        </div>
    </div>
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:1rem;">
        <div>
            <label for="{{ header_form.document_number.id_for_label }}">{{ header_form.document_number.label }}</label>
            {{ header_form.document_number }}
            {{ header_form.document_number.errors }}
        </div>
        <div>
            <label for="{{ header_form.comment.id_for_label }}">{{ header_form.comment.label }}</label>
            {{ header_form.comment }}
            {{ header_form.comment.errors }}
        </div>
    </div>

    {% if line_formset.non_form_errors %}
        <div class="message error">{{ line_formset.non_form_errors }}</div>
    {% endif %}

    {{ line_formset.management_form }}
    <div class="table-wrapper">
        <table class="table" style="width:100%;border-collapse:collapse;">
            <thead>
                <tr>
                    <th style="width:60%;">Produit</th>
                    <th style="width:20%;">Quantité</th>
                    <th style="width:20%;">Action</th>
                </tr>
            </thead>
            <tbody id="movement-lines-body">
                {% for form in line_formset.forms %}
                <tr class="line-row" data-index="{{ forloop.counter0 }}">
                    <td>
                        <div class="autocomplete-panel">
                            <input type="text" class="form-control product-search" placeholder="Rechercher un produit" autocomplete="off">
                            {{ form.product }}
                            <div class="autocomplete-results" data-autocomplete></div>
                        </div>
                        <div class="product-preview" data-product-preview>
                            <div class="product-thumb fallback">?</div>
                            <div>
                                <strong>Aucun produit sélectionné</strong>
                                <small style="color:var(--muted);">Tapez un nom ou une référence pour commencer.</small>
                            </div>
                        </div>
                        {% for error in form.product.errors %}
                            <div class="field-error">{{ error }}</div>
                        {% endfor %}
                    </td>
                    <td>
                        {{ form.quantity }}
                        {% for error in form.quantity.errors %}
                            <div class="field-error">{{ error }}</div>
                        {% endfor %}
                    </td>
                    <td style="text-align:right;">
                        {% if line_formset.can_delete %}
                            <input type="checkbox" name="{{ form.prefix }}-DELETE" id="id_{{ form.prefix }}-DELETE" style="display:none;">
                        {% endif %}
                        <button type="button" class="btn secondary small" data-action="remove-line">Supprimer</button>
                    </td>
                </tr>
                {% empty %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:0.5rem;">
        <button type="button" class="btn secondary" id="add-line-btn">+ Ajouter une ligne</button>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:0.5rem;margin-top:0.5rem;">
        <a href="{% url 'inventory:dashboard' %}" class="btn secondary">Annuler</a>
        <button type="submit" class="btn">Enregistrer</button>
    </div>
</form>

<template id="movement-line-template">
    <tr class="line-row" data-index="__prefix__">
        <td>
            <div class="autocomplete-panel">
                <input type="text" class="form-control product-search" placeholder="Rechercher un produit" autocomplete="off">
                {{ line_formset.empty_form.product.as_widget|safe }}
                <div class="autocomplete-results" data-autocomplete></div>
            </div>
            <div class="product-preview" data-product-preview>
                <div class="product-thumb fallback">?</div>
                <div>
                    <strong>Aucun produit sélectionné</strong>
                    <small style="color:var(--muted);">Tapez un nom ou une référence pour commencer.</small>
                </div>
            </div>
        </td>
        <td>
            {{ line_formset.empty_form.quantity.as_widget|safe }}
        </td>
        <td style="text-align:right;">
            {% if line_formset.can_delete %}
                <input type="checkbox" name="lines-__prefix__-DELETE" id="id_lines-__prefix__-DELETE" style="display:none;">
            {% endif %}
            <button type="button" class="btn secondary small" data-action="remove-line">Supprimer</button>
        </td>
    </tr>
</template>

<style>
.table th, .table td { border-bottom:1px solid var(--border); padding:0.5rem; }
.field-error { color:#b91c1c; font-size:0.85rem; }
.btn.small { padding:0.35rem 0.75rem; font-size:0.9rem; }
.table select,
.table input {
    background:#fff;
    color:#0f172a;
    border:1px solid var(--border);
}
.table select:focus,
.table input:focus {
    outline:2px solid var(--accent-strong);
    outline-offset:1px;
    border-color: var(--accent-strong);
}
.product-select { display:none; }
.autocomplete-panel { position:relative; }
.autocomplete-results {
    position:absolute;
    top:calc(100% + 4px);
    left:0;
    right:0;
    background:#0f172a;
    color:#e2e8f0;
    border:1px solid var(--border);
    border-radius:8px;
    box-shadow:0 10px 30px rgba(0,0,0,0.18);
    z-index:30;
    max-height:220px;
    overflow-y:auto;
}
.autocomplete-option {
    display:flex;
    align-items:center;
    gap:0.5rem;
    width:100%;
    border:none;
    background:transparent;
    padding:0.55rem 0.7rem;
    cursor:pointer;
    color:inherit;
    text-align:left;
}
.autocomplete-option:hover,
.autocomplete-option:focus { background:rgba(255,255,255,0.06); outline:none; }
.autocomplete-empty { padding:0.55rem 0.7rem; color:#cbd5e1; }
.product-thumb {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: #f3f4f6;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    flex-shrink: 0;
    border: 1px solid var(--border);
}
.product-thumb img { width: 100%; height: 100%; object-fit: cover; }
.product-thumb.fallback { font-weight: 600; color: #cbd5e1; }
.product-preview {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-top: 0.4rem;
    color: var(--muted);
}
.product-preview strong { color: inherit; display: block; }
#id_movement_type {
    background:#fff;
    color:#0f172a;
    border:1px solid var(--border);
    border-radius:8px;
    padding:0.45rem 0.5rem;
}
#id_movement_type:focus {
    outline:2px solid var(--accent-strong);
    outline-offset:1px;
    border-color: var(--accent-strong);
}
</style>

{{ product_dataset|json_script:"product-dataset" }}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const body = document.getElementById("movement-lines-body");
    const template = document.getElementById("movement-line-template").innerHTML.trim();
    const totalInput = document.getElementById("id_lines-TOTAL_FORMS");
    const productDataset = JSON.parse(document.getElementById("product-dataset").textContent || "[]");

    const createThumb = (item) => {
        const thumb = document.createElement("div");
        thumb.className = "product-thumb";
        if (item && item.image_url) {
            const img = document.createElement("img");
            img.src = item.image_url;
            img.alt = item.name || "Produit";
            thumb.appendChild(img);
        } else {
            thumb.classList.add("fallback");
            thumb.textContent = (item?.name || "?").slice(0, 1).toUpperCase();
        }
        return thumb;
    };

    const renderProductPreview = (wrapper, product) => {
        if (!wrapper) return;
        wrapper.innerHTML = "";
        const thumb = createThumb(product);
        const info = document.createElement("div");
        const title = document.createElement("strong");
        title.textContent = product ? product.name : "Aucun produit sélectionné";
        const subtitle = document.createElement("small");
        subtitle.style.color = "var(--muted)";
        subtitle.textContent = product ? (product.sku || "Référence manquante") : "Tapez un nom ou une référence pour commencer.";
        info.append(title, subtitle);
        wrapper.append(thumb, info);
    };

    const filterProducts = (value) => {
        const normalized = (value || "").toLowerCase().trim();
        if (!normalized) return [];
        return productDataset
            .filter(
                (p) =>
                    (p.name || "").toLowerCase().includes(normalized) ||
                    (p.sku || "").toLowerCase().includes(normalized)
            )
            .slice(0, 8);
    };

    const selectProduct = (row, product) => {
        if (!product) return;
        const select = row.querySelector(".product-select") || row.querySelector("select");
        if (select) {
            let option = select.querySelector(`option[value="${product.id}"]`);
            if (!option) {
                option = document.createElement("option");
                option.value = product.id;
                option.textContent = `${product.sku || ""} ${product.name}`;
                select.appendChild(option);
            }
            select.value = product.id.toString();
        }
        const searchInput = row.querySelector(".product-search");
        if (searchInput) {
            const sku = product.sku ? ` (${product.sku})` : "";
            searchInput.value = `${product.name}${sku}`;
        }
        const preview = row.querySelector("[data-product-preview]");
        renderProductPreview(preview, product);
    };

    const bindRow = (row) => {
        const removeBtn = row.querySelector("[data-action='remove-line']");
        if (removeBtn) {
            removeBtn.addEventListener("click", () => {
                const deleteInput = row.querySelector("input[name$='-DELETE']");
                if (deleteInput) {
                    deleteInput.checked = true;
                }
                row.style.display = "none";
            });
        }

        const searchInput = row.querySelector(".product-search");
        const results = row.querySelector("[data-autocomplete]");
        const preview = row.querySelector("[data-product-preview]");
        if (searchInput) {
            const select = row.querySelector(".product-select") || row.querySelector("select");
            if (select && select.value) {
                const current = productDataset.find((p) => p.id.toString() === select.value);
                if (current) {
                    const sku = current.sku ? ` (${current.sku})` : "";
                    searchInput.value = `${current.name}${sku}`;
                    renderProductPreview(preview, current);
                }
            } else {
                renderProductPreview(preview, null);
            }
            const renderResults = (items) => {
                if (!results) return;
                results.innerHTML = "";
                if (!items.length) {
                    const empty = document.createElement("div");
                    empty.className = "autocomplete-empty";
                    empty.textContent = "Aucun produit";
                    results.appendChild(empty);
                    return;
                }
                items.forEach((product) => {
                    const option = document.createElement("button");
                    option.type = "button";
                    option.className = "autocomplete-option";
                    option.appendChild(createThumb(product));
                    const label = document.createElement("div");
                    const sku = product.sku ? ` (${product.sku})` : "";
                    label.textContent = `${product.name}${sku}`;
                    option.appendChild(label);
                    option.addEventListener("mousedown", (e) => e.preventDefault());
                    option.addEventListener("click", () => {
                        selectProduct(row, product);
                        results.innerHTML = "";
                    });
                    results.appendChild(option);
                });
            };
            searchInput.addEventListener("input", () => {
                const matches = filterProducts(searchInput.value);
                renderResults(matches);
            });
            searchInput.addEventListener("focus", () => {
                const matches = filterProducts(searchInput.value);
                renderResults(matches);
            });
            searchInput.addEventListener("blur", () => {
                setTimeout(() => results && (results.innerHTML = ""), 150);
            });
        }
    };

    const addLine = () => {
        const index = parseInt(totalInput.value || "0", 10);
        const html = template.replace(/__prefix__/g, index);
        const wrapper = document.createElement("tbody");
        wrapper.innerHTML = html;
        const row = wrapper.firstElementChild;
        body.appendChild(row);
        totalInput.value = index + 1;
        bindRow(row);
    };

    body.querySelectorAll(".line-row").forEach(bindRow);

    const addBtn = document.getElementById("add-line-btn");
    if (addBtn) {
        addBtn.addEventListener("click", addLine);
    }
});
</script>
{% endblock %}

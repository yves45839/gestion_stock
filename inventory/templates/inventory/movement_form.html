{% extends "inventory/base.html" %}
{% block title %}Nouveau mouvement{% endblock %}
{% block content %}
<style>
    .product-select { display: block; width: 100%; }
    .panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 18px;
        box-shadow: 0 18px 45px rgba(15,124,144,0.12);
        padding: 1.25rem;
    }
    .section-label {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.7rem;
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--accent-strong);
        font-weight: 700;
        font-size: 0.85rem;
        border: 1px solid rgba(15,124,144,0.25);
    }
    .info-row {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
        color: var(--muted);
        font-size: 0.95rem;
    }
    .info-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.65rem;
        border-radius: 10px;
        background: var(--surface-muted);
        border: 1px solid var(--border);
        font-weight: 600;
    }
    .movement-lines { display: grid; gap: 1rem; }
    .line-footer {
        display: flex;
        justify-content: flex-end;
        margin-top: 0.5rem;
    }
    .movement-line {
        position: relative;
        border-radius: 16px;
        border: 1px dashed var(--border);
        background: #f8fbff;
        box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
        padding: 1rem 1.1rem;
    }
    .line-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.65rem;
    }
    .line-tag {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 12px;
        font-weight: 800;
        background: var(--accent-soft);
        color: var(--accent-strong);
        border: 1px solid rgba(15,124,144,0.3);
        box-shadow: 0 4px 12px rgba(15,124,144,0.15);
    }
    .line-actions { display: flex; align-items: center; gap: 0.5rem; }
    .line-grid {
        display: grid;
        grid-template-columns: 1.1fr 0.45fr auto;
        gap: 0.75rem;
        align-items: end;
    }
    .trash-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        padding: 0.65rem 0.9rem;
        border: 1px solid var(--border);
        background: #fff5f5;
        color: #b91c1c;
        cursor: pointer;
        font-weight: 700;
        gap: 0.4rem;
    }
    .trash-btn:hover { background: #fee2e2; }
    .autocomplete-panel { position: relative; }
    .autocomplete-results {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 10px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
        z-index: 20;
        max-height: 260px;
        overflow-y: auto;
    }
    .autocomplete-option {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        border: none;
        background: transparent;
        padding: 0.65rem 0.85rem;
        cursor: pointer;
        text-align: left;
    }
    .autocomplete-option:hover,
    .autocomplete-option:focus { background: #f7f7f7; outline: none; }
    .autocomplete-empty { padding: 0.65rem 0.85rem; color: var(--muted); }
    .product-thumb {
        width: 42px;
        height: 42px;
        border-radius: 8px;
        background: #f3f4f6;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        flex-shrink: 0;
        border: 1px solid var(--border);
    }
    .product-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .product-thumb.fallback { font-weight: 600; color: #6b7280; }
    .product-preview { display: flex; align-items: center; gap: 0.75rem; margin-top: 0.35rem; color: var(--muted); }
    .product-preview strong { color: inherit; display: block; }
    .panel input,
    .panel select,
    .panel textarea {
        background: #1a2a45;
        color: #f8fbff;
        border: 1px solid var(--border-strong);
    }
    .panel input::placeholder,
    .panel textarea::placeholder {
        color: #e3edff;
    }
</style>

<section class="page-header reveal">
    <div>
        <p class="eyebrow">Stock</p>
        <h1 class="page-title">Nouveau mouvement</h1>
        <p class="lead">Scanner un produit ou enregistrer manuellement une entr√©e/sortie.</p>
    </div>
</section>

<section class="surface stack" style="max-width:1100px; margin:0 auto;">
    <div class="surface surface-muted reveal" data-delay="100">
        <h2 class="surface-title">Mode scanner</h2>
        <p class="muted-text">Scannez un code-barres pour s√©lectionner automatiquement le produit et incr√©menter la quantit√©.</p>
        <div class="toolbar">
            <input id="scan-input" type="text" placeholder="Pr√™t pour scan..." data-lookup-url="{% url 'inventory:lookup_product' %}" style="max-width:320px;">
            <button type="button" class="btn secondary" id="scan-reset">R√©initialiser</button>
        </div>
        <div id="scan-summary" class="muted-text" style="margin-top:0.75rem;">En attente d'un premier scan.</div>
        <ul id="scan-history" class="muted-text" style="list-style:none; padding-left:0; margin:0; font-size:0.9rem;"></ul>
    </div>

    <h2 class="surface-title reveal" data-delay="140">Enregistrer un mouvement</h2>
    <form method="post" novalidate id="movement-form" class="stack panel reveal" data-delay="160" style="gap:1rem;">
        {% csrf_token %}
        <div class="info-row">
            <span class="section-label">D√©tails mouvement</span>
            <span class="info-chip">Site : {{ active_site.name|default:"Vue globale" }}</span>
            <span class="info-chip">Date : {{ header_form.movement_date.value|default:header_form.movement_date.initial }}</span>
        </div>
        {% if header_form.non_field_errors %}
            <div class="message error">{{ header_form.non_field_errors }}</div>
        {% endif %}
        <div class="form-grid">
            <div class="field">
                <label for="{{ header_form.movement_type.id_for_label }}">{{ header_form.movement_type.label }}</label>
                {{ header_form.movement_type }}
                {{ header_form.movement_type.errors }}
            </div>
            <div class="field">
                <label for="{{ header_form.site.id_for_label }}">{{ header_form.site.label }}</label>
                {{ header_form.site }}
                {{ header_form.site.errors }}
            </div>
            <div class="field">
                <label for="{{ header_form.movement_date.id_for_label }}">{{ header_form.movement_date.label }}</label>
                {{ header_form.movement_date }}
                {{ header_form.movement_date.errors }}
            </div>
        </div>
        <div class="field">
            <label for="{{ header_form.document_number.id_for_label }}">{{ header_form.document_number.label }}</label>
            {{ header_form.document_number }}
            {{ header_form.document_number.errors }}
        </div>
        <div class="field">
            <label for="{{ header_form.comment.id_for_label }}">{{ header_form.comment.label }}</label>
            {{ header_form.comment }}
            {{ header_form.comment.errors }}
        </div>
        <div class="stack">
            <div class="surface-header" style="margin:0; padding:0; border:none;">
                <div>
                    <p class="eyebrow" style="margin:0;">Lignes produits</p>
                    <h3 class="surface-title" style="margin:0;">S√©lection et quantit√©s</h3>
                </div>
            </div>
            {{ line_formset.management_form }}
            <div id="movement-lines" class="movement-lines">
                {% for form in line_formset %}
                    <div class="surface surface-muted movement-line">
                        <div class="line-header">
                            <div class="line-actions">
                                <span class="line-tag">{{ forloop.counter }}</span>
                                <div class="muted-text">Ligne produit</div>
                            </div>
                            {% if line_formset.can_delete %}
                                <label class="trash-btn" data-action="remove-line">
                                    {{ form.DELETE }} üóë Supprimer
                                </label>
                            {% endif %}
                        </div>
                        {% if form.non_field_errors %}
                            <div class="message error">{{ form.non_field_errors }}</div>
                        {% endif %}
                        <div class="line-grid">
                            <div class="field">
                                <label for="{{ form.product.id_for_label }}">{{ form.product.label }}</label>
                                <div class="autocomplete-panel">
                                    <input type="text" class="form-control product-search" placeholder="Chercher un produit par nom ou r√©f√©rence" autocomplete="off">
                                    {{ form.product }}
                                    <div class="autocomplete-results" data-autocomplete></div>
                                </div>
                                <div class="product-preview" data-product-preview>
                                    <div class="product-thumb fallback">?</div>
                                    <div>
                                        <strong>Aucun produit s√©lectionn√©</strong>
                                        <small style="color:var(--muted);">Saisissez un nom ou une r√©f√©rence pour commencer.</small>
                                    </div>
                                </div>
                                {{ form.product.errors }}
                            </div>
                            <div class="field">
                                <label for="{{ form.quantity.id_for_label }}">{{ form.quantity.label }}</label>
                                {{ form.quantity }}
                                {{ form.quantity.errors }}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div class="line-footer">
                <button type="button" class="btn secondary" id="add-line" data-add-movement-line>+ Ajouter une ligne produit</button>
            </div>
        </div>
        <div id="pre-submit-message" class="message info" style="display:none; margin-top:0;">
            Choisissez un type de mouvement puis confirmez le r√É¬©capitulatif avant validation.
        </div>
        <div class="toolbar" style="margin-top:0.5rem; flex-wrap:wrap;">
            <button type="submit" class="btn">Enregistrer</button>
            <a href="{% url 'inventory:dashboard' %}" class="btn secondary">Annuler</a>
        </div>
        <template id="line-template">
            <div class="surface surface-muted movement-line reveal" data-delay="180">
                <div class="line-header">
                    <div class="line-actions">
                        <span class="line-tag">#</span>
                        <div class="muted-text">Ligne produit</div>
                    </div>
                    <label class="trash-btn" data-action="remove-line">
                        __DELETE__
                        üóë Supprimer
                    </label>
                </div>
                <div class="line-grid">
                    <div class="field">
                        <label>Produit</label>
                        <div class="autocomplete-panel">
                            <input type="text" class="form-control product-search" placeholder="Chercher un produit par nom ou r√©f√©rence" autocomplete="off">
                            __PRODUCT__
                            <div class="autocomplete-results" data-autocomplete></div>
                        </div>
                        <div class="product-preview" data-product-preview>
                            <div class="product-thumb fallback">?</div>
                            <div>
                                <strong>Aucun produit s√©lectionn√©</strong>
                                <small style="color:var(--muted);">Saisissez un nom ou une r√©f√©rence pour commencer.</small>
                            </div>
                        </div>
                    </div>
                    <div class="field">
                        <label>Quantit√©</label>
                        __QUANTITY__
                    </div>
                </div>
            </div>
        </template>
        <div id="empty-form" style="display:none;">{{ line_formset.empty_form }}</div>
    </form>
</section>
{{ product_dataset|json_script:"product-dataset" }}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const scanInput = document.getElementById("scan-input");
        const resetBtn = document.getElementById("scan-reset");
        const summary = document.getElementById("scan-summary");
        const historyList = document.getElementById("scan-history");
        const productSelects = () => Array.from(document.querySelectorAll(".product-select"));
        const quantityInputs = () => Array.from(document.querySelectorAll(".movement-line input[type='number']"));
        const history = [];
        const totalFormsInput = document.getElementById("id_lines-TOTAL_FORMS");
        const lineTemplate = document.getElementById("line-template");
        const linesContainer = document.getElementById("movement-lines");
        const emptyForm = document.getElementById("empty-form");
        const productDataset = JSON.parse(document.getElementById("product-dataset").textContent || "[]");

        const createThumb = (product) => {
            const thumb = document.createElement("div");
            thumb.className = "product-thumb";
            if (product && product.image_url) {
                const img = document.createElement("img");
                img.src = product.image_url;
                img.alt = product.name || "Produit";
                thumb.appendChild(img);
            } else {
                thumb.classList.add("fallback");
                thumb.textContent = (product?.name || "?").slice(0, 1).toUpperCase();
            }
            return thumb;
        };

        const renderPreview = (wrapper, product) => {
            if (!wrapper) return;
            wrapper.innerHTML = "";
            const thumb = createThumb(product);
            const info = document.createElement("div");
            const title = document.createElement("strong");
            title.textContent = product ? product.name : "Aucun produit s√©lectionn√©";
            const subtitle = document.createElement("small");
            subtitle.style.color = "var(--muted)";
            subtitle.textContent = product
                ? product.sku || "R√©f√©rence manquante"
                : "Saisissez un nom ou une r√©f√©rence pour commencer.";
            info.append(title, subtitle);
            wrapper.append(thumb, info);
        };

        const ensureSelectTagged = (select) => {
            if (select && !select.classList.contains("product-select")) {
                select.classList.add("product-select");
            }
        };

        const ensureOptionExists = (product) => {
            productSelects().forEach((select) => {
                ensureSelectTagged(select);
                let option = select.querySelector(`option[value="${product.id}"]`);
                if (!option) {
                    option = document.createElement("option");
                    option.value = product.id;
                    option.textContent = `${product.sku} - ${product.name}`;
                    select.appendChild(option);
                }
            });
        };

        const bindAutocomplete = (lineElement) => {
            const searchInput = lineElement.querySelector(".product-search");
            const select = lineElement.querySelector(".product-select") || lineElement.querySelector("select");
            ensureSelectTagged(select);
            const results = lineElement.querySelector("[data-autocomplete]");
            const preview = lineElement.querySelector("[data-product-preview]");
            renderPreview(
                preview,
                productDataset.find((p) => p.id.toString() === (select?.value || "")) || null,
            );

            const selectProduct = (product) => {
                if (!product || !select) return;
                ensureOptionExists(product);
                select.value = product.id.toString();
                if (searchInput) {
                    searchInput.value = `${product.name} (${product.sku || "R√©f. inconnue"})`;
                }
                renderPreview(preview, product);
                if (results) {
                    results.innerHTML = "";
                }
            };

            const filterProducts = (term) => {
                const normalized = term.trim().toLowerCase();
                if (!normalized) return [];
                return productDataset
                    .filter(
                        (product) =>
                            (product.name || "").toLowerCase().includes(normalized) ||
                            (product.sku || "").toLowerCase().includes(normalized),
                    )
                    .slice(0, 8);
            };

            const renderResults = (items) => {
                if (!results) return;
                results.innerHTML = "";
                if (!items.length) {
                    const empty = document.createElement("div");
                    empty.className = "autocomplete-empty";
                    empty.textContent = "Aucun produit trouv√©";
                    results.appendChild(empty);
                    return;
                }
                items.forEach((product) => {
                    const option = document.createElement("button");
                    option.type = "button";
                    option.className = "autocomplete-option";
                    option.appendChild(createThumb(product));
                    const meta = document.createElement("div");
                    const title = document.createElement("div");
                    title.textContent = product.name;
                    title.style.fontWeight = "600";
                    const subtitle = document.createElement("div");
                    subtitle.textContent = product.sku || "Sans r√©f√©rence";
                    subtitle.style.color = "var(--muted)";
                    meta.append(title, subtitle);
                    option.appendChild(meta);
                    option.addEventListener("mousedown", (event) => {
                        event.preventDefault();
                        selectProduct(product);
                    });
                    option.addEventListener("click", () => selectProduct(product));
                    results.appendChild(option);
                });
            };

            if (searchInput) {
                searchInput.addEventListener("input", () => {
                    const matches = filterProducts(searchInput.value);
                    renderResults(matches);
                });
                searchInput.addEventListener("focus", () => {
                    const matches = filterProducts(searchInput.value);
                    renderResults(matches);
                });
                searchInput.addEventListener("blur", () => {
                    setTimeout(() => results && (results.innerHTML = ""), 150);
                    if (!select || select.value) return;
                    const matches = filterProducts(searchInput.value);
                    if (matches.length === 1) {
                        selectProduct(matches[0]);
                    }
                });
            }
            if (select) {
                select.addEventListener("change", () => {
                    const product = productDataset.find((p) => p.id.toString() === select.value);
                    renderPreview(preview, product || null);
                });
            }
        };

        const getLines = () => Array.from(linesContainer.querySelectorAll(".movement-line"));

        const refreshIndexes = () => {
            const lines = getLines();
            lines.forEach((line, index) => {
                line.dataset.formIndex = index;
                const tag = line.querySelector(".line-tag");
                if (tag) tag.textContent = index + 1;
                line.querySelectorAll("input, select").forEach((input) => {
                    if (!input.name) {
                        return;
                    }
                    input.name = input.name.replace(/lines-\d+-/, `lines-${index}-`);
                    if (input.id) {
                        input.id = input.id.replace(/id_lines-\d+-/, `id_lines-${index}-`);
                    }
                });
            });
            if (totalFormsInput) {
                totalFormsInput.value = lines.length;
            }
        };

        if (!scanInput) {
            return;
        }

        const removeLine = (line) => {
            line.remove();
            refreshIndexes();
        };

        const attachLine = (line) => {
            bindAutocomplete(line);
            const removeBtn = line.querySelector("[data-action='remove-line']");
            if (removeBtn) {
                removeBtn.addEventListener("click", (event) => {
                    event.preventDefault();
                    removeLine(line);
                });
            }
        };

        const focusScan = () => {
            scanInput.focus();
            scanInput.select();
        };

        const renderHistory = () => {
            historyList.innerHTML = "";
            history.slice(-5).reverse().forEach((entry) => {
                const li = document.createElement("li");
                li.textContent = `${entry.time} - ${entry.name} (${entry.sku})`;
                historyList.appendChild(li);
            });
        };

        const getCurrentLine = () => {
            const selects = productSelects();
            if (selects.length === 0) {
                return { productSelect: null, quantityInput: null };
            }
            const productSelect = selects[selects.length - 1];
            const quantityInput = quantityInputs()[quantityInputs().length - 1];
            return { productSelect, quantityInput };
        };

        const handleSuccess = (product, meta = {}) => {
            ensureOptionExists(product);
            const { productSelect, quantityInput } = getCurrentLine();
            if (productSelect) {
                const previous = productSelect.value;
                productSelect.value = product.id.toString();
                if (quantityInput) {
                    const current = parseInt(quantityInput.value || "0", 10) || 0;
                    if (previous === product.id.toString()) {
                        quantityInput.value = current + 1;
                    } else {
                        quantityInput.value = Math.max(current, 1) || 1;
                    }
                }
            }
            if (meta.created) {
                summary.textContent = `Nouveau produit cr√©√© : ${product.name} (${product.sku}). Pensez √† enregistrer le mouvement pour initialiser le stock.`;
            } else {
                summary.textContent = `S√©lection : ${product.name} (${product.sku}) - Stock actuel ${product.stock_quantity}`;
            }
            summary.style.color = meta.created ? "#047857" : "var(--muted)";
            history.push({
                name: product.name,
                sku: product.sku,
                time: new Date().toLocaleTimeString(),
            });
            renderHistory();
            document.querySelectorAll(".movement-line").forEach((line) => {
                const select = line.querySelector(".product-select");
                const preview = line.querySelector("[data-product-preview]");
                if (select && select.value === product.id.toString()) {
                    renderPreview(preview, product);
                }
            });
        };

        const handleError = (message) => {
            summary.textContent = message;
            summary.style.color = "#b91c1c";
            setTimeout(() => {
                summary.style.color = "var(--muted)";
            }, 2000);
        };

        const lookupProduct = (value) => {
            const url = new URL(scanInput.dataset.lookupUrl, window.location.origin);
            url.searchParams.set("code", value);
            fetch(url)
                .then((response) => response.json())
                .then((payload) => {
                    if (payload.found) {
                        handleSuccess(payload.product, { created: payload.created });
                    } else {
                        handleError(payload.error || "Produit introuvable");
                    }
                })
                .catch(() => handleError("Erreur r√©seau lors de la recherche."));
        };

        scanInput.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                const value = scanInput.value.trim();
                if (!value) {
                    return;
                }
                lookupProduct(value);
                scanInput.value = "";
            }
        });

        resetBtn.addEventListener("click", () => {
            history.splice(0, history.length);
            renderHistory();
            summary.textContent = "Historique r√©initialis√©.";
            quantityInputs().forEach((input) => (input.value = ""));
            productSelects().forEach((select) => (select.value = ""));
            focusScan();
        });

        const addLine = () => {
            if (!lineTemplate || !emptyForm) {
                return;
            }
            const formIndex = getLines().length;
            const templateHtml = emptyForm.innerHTML.replace(/__prefix__/g, formIndex);
            const wrapper = document.createElement("div");
            wrapper.innerHTML = templateHtml;
            const productField = wrapper.querySelector("select");
            const quantityField = wrapper.querySelector("input[type='number']");
            const deleteField = wrapper.querySelector("input[name$='-DELETE']");
            ensureSelectTagged(productField);
            let lineHtml = lineTemplate.innerHTML.trim();
            lineHtml = lineHtml.replace("__PRODUCT__", productField.outerHTML);
            lineHtml = lineHtml.replace("__QUANTITY__", quantityField.outerHTML);
            lineHtml = lineHtml.replace("__DELETE__", deleteField ? deleteField.outerHTML : "");
            const lineWrapper = document.createElement("div");
            lineWrapper.innerHTML = lineHtml;
            const newLine = lineWrapper.firstElementChild;
            linesContainer.appendChild(newLine);
            attachLine(newLine);
            refreshIndexes();
        };

        getLines().forEach((line) => {
            const select = line.querySelector("select");
            ensureSelectTagged(select);
            attachLine(line);
        });
        refreshIndexes();

        Array.from(document.querySelectorAll("[data-add-movement-line]"))
            .filter(Boolean)
            .forEach((btn) => {
                btn.addEventListener("click", (event) => {
                    event.preventDefault();
                    addLine();
                });
            });

        const movementForm = document.getElementById("movement-form");
        const preSubmitMessage = document.getElementById("pre-submit-message");
        const movementTypeSelect = document.getElementById("id_movement_type");

        if (movementForm) {
            movementForm.addEventListener("submit", (event) => {
                const selectedType = movementTypeSelect ? movementTypeSelect.options[movementTypeSelect.selectedIndex]?.text : "";
                const filledLines = Array.from(document.querySelectorAll(".movement-line")).filter((line) => {
                    const select = line.querySelector(".product-select");
                    const qty = line.querySelector("input[type='number']");
                    return select && select.value && qty && Number(qty.value) > 0;
                });
                if (!movementTypeSelect || !movementTypeSelect.value) {
                    event.preventDefault();
                    if (preSubmitMessage) {
                        preSubmitMessage.style.display = "block";
                        preSubmitMessage.textContent = "Choisissez un type de mouvement avant de valider.";
                    }
                    movementTypeSelect?.focus();
                    return;
                }
                const confirmationText =
                    `Confirmer le mouvement "${selectedType}" avec ${filledLines.length || 0} ligne(s) produit ?`;
                if (!window.confirm(confirmationText)) {
                    event.preventDefault();
                    if (preSubmitMessage) {
                        preSubmitMessage.style.display = "block";
                        preSubmitMessage.textContent = "Validation annul√©e. Vous pouvez ajuster les lignes ou le type avant de r√©essayer.";
                    }
                    return;
                }
                if (preSubmitMessage) {
                    preSubmitMessage.style.display = "block";
                    preSubmitMessage.textContent = "Enregistrement en cours...";
                }
            });
        }

        focusScan();
    });
</script>
{% endblock %}

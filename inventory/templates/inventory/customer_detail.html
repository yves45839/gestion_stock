{% extends "inventory/base.html" %}
{% block title %}Compte client - {{ customer.display_name }}{% endblock %}
{% block content %}
<section class="page-header reveal">
    <div>
        <p class="eyebrow">Compte client</p>
        <h1 class="page-title">{{ customer.display_name }}</h1>
        <p class="lead">Référence {{ customer.reference }}{% if customer.company_name %} — {{ customer.company_name }}{% endif %}</p>
    </div>
    <div class="toolbar">
        <a href="{% url 'inventory:customer_update' customer.pk %}" class="btn secondary">Modifier</a>
        <a href="{% url 'inventory:customer_list' %}" class="btn secondary">Retour</a>
    </div>
</section>

<section class="surface reveal" data-delay="100">
    <div class="grid auto-3">
        <div>
            <p class="muted-text" style="margin:0;">Solde actuel</p>
            <p class="value" style="margin:0; font-weight:800;">{{ customer.balance|floatformat:2 }} FCFA</p>
        </div>
        <div>
            <p class="muted-text" style="margin:0;">Plafond de crédit</p>
            <p class="value" style="margin:0; font-weight:800;">{{ customer.credit_limit|floatformat:2 }} FCFA</p>
        </div>
        <div>
            <p class="muted-text" style="margin:0;">Contact</p>
            <p class="value" style="margin:0; font-size:1rem;">
                {{ customer.email|default:"-" }}<br>
                {{ customer.phone|default:"-" }}
            </p>
        </div>
    </div>
</section>

<section class="split split-70">
    <div class="surface reveal" data-delay="140">
        <div class="surface-header">
            <h2 class="surface-title">Historique du compte</h2>
        </div>
        {% if entries %}
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Libellé</th>
                        <th>Type</th>
                        <th>Montant</th>
                        <th>Solde</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in entries %}
                        <tr>
                            <td>{{ entry.occurred_at|date:"d/m/Y H:i" }}</td>
                            <td>
                                {{ entry.label }}
                                {% if entry.sale %}
                                    <div class="muted-text" style="font-size:0.85rem;">Vente {{ entry.sale.reference }}</div>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge {% if entry.entry_type == 'debit' %}warn{% else %}success{% endif %}">
                                    {{ entry.get_entry_type_display }}
                                </span>
                            </td>
                            <td>{{ entry.amount|floatformat:2 }} FCFA</td>
                            <td>{{ entry.running_balance|floatformat:2 }} FCFA</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="muted-text" style="margin:0;">Aucun mouvement encore enregistré pour ce client.</p>
        {% endif %}
    </div>
    <div class="surface reveal" data-delay="180">
        <h2 class="surface-title">Ajouter un mouvement</h2>
        <form method="post" class="stack">
            <input type="hidden" name="form_type" value="entry">
            {% csrf_token %}
            {% if entry_form.non_field_errors %}
                <div class="message error">{{ entry_form.non_field_errors }}</div>
            {% endif %}
            {% for field in entry_form %}
                <div class="field">
                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                    {{ field }}
                    {% for error in field.errors %}
                        <div class="field-error">{{ error }}</div>
                    {% endfor %}
                </div>
            {% endfor %}
            <button type="submit" class="btn">Enregistrer</button>
        </form>
        <p class="muted-text" style="margin-top:0.75rem;">Utilisez un débit pour facturer (augmente la dette) ou un crédit pour enregistrer un paiement.</p>
    </div>
</section>

<section class="split">
    <div class="surface reveal" data-delay="140">
        <h2 class="surface-title">Modifier le client</h2>
        <form method="post" class="stack" style="margin-top:0.75rem;">
            <input type="hidden" name="form_type" value="customer">
            {% csrf_token %}
            {% if customer_form.non_field_errors %}
                <div class="message error">{{ customer_form.non_field_errors|join:", " }}</div>
            {% endif %}
            <div class="form-grid">
                {% for field in customer_form %}
                    <div class="field">
                        {{ field.label_tag }}
                        {{ field }}
                        {% for error in field.errors %}
                            <div class="field-error">{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            <button type="submit" class="btn">Enregistrer les modifications</button>
        </form>
    </div>
    <div class="surface reveal" data-delay="180">
        <h2 class="surface-title">Historique des versions</h2>
        {% if versions %}
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Action</th>
                        <th>Utilisateur</th>
                        <th>Nom</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for version in versions %}
                        <tr>
                            <td>{{ version.created_at|date:"d/m/Y H:i" }}</td>
                            <td>{{ version.get_action_display }}</td>
                            <td>
                                {% if version.user %}
                                    {{ version.user.get_full_name|default:version.user.username }}
                                {% else %}
                                    Système
                                {% endif %}
                            </td>
                            <td>{{ version.snapshot.name|default:version.snapshot.company_name|default:"-" }}</td>
                            <td>
                                <form method="post" action="{% url 'inventory:version_revert' version.pk %}" style="margin:0;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn secondary" style="padding:0.4rem 0.9rem;">Restaurer</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="muted-text" style="margin:0;">Aucune version enregistrée pour ce client.</p>
        {% endif %}
    </div>
</section>
{% endblock %}

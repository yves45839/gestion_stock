{% extends "inventory/base.html" %}
{% block title %}IA - Enrichissement produits{% endblock %}
{% block content %}
<section class="page-header reveal">
    <div>
        <p class="eyebrow">Agent IA</p>
        <h1 class="page-title">Amélioration automatique des fiches produit</h1>
        <p class="lead">
            Lance le bot pour générer des descriptions plus accrocheuses et
            récupérer un visuel produit basé sur la référence.
        </p>
    </div>
    <div class="toolbar">
        <a class="btn secondary" href="{% url 'inventory:inventory_overview' %}">Produits</a>
        <a class="btn ghost" href="{% url 'inventory:import_products' %}">Import</a>
    </div>
</section>

<section class="stat-grid">
    <div class="surface reveal" data-delay="40">
        <p class="eyebrow">Références</p>
        <p class="surface-title">Total suivi</p>
        <p class="value">{{ stats.total_products }}</p>
        <p class="muted-text">Toutes les références disponibles</p>
    </div>
    <div class="surface reveal" data-delay="80">
        <p class="eyebrow">Contenu manquant</p>
        <p class="surface-title">Descriptions vides</p>
        <p class="value">{{ stats.missing_description }}</p>
        <p class="muted-text">
            {{ stats.missing_both }} sont aussi sans visuel.
        </p>
    </div>
    <div class="surface surface-muted reveal" data-delay="120">
        <p class="eyebrow">Visuels</p>
        <p class="surface-title">Images manquantes</p>
        <p class="value">{{ stats.missing_image }}</p>
        <p class="muted-text">Image récupérée depuis la source configurée.</p>
    </div>
    <div class="surface reveal" data-delay="140">
        <p class="eyebrow">Visuels</p>
        <p class="surface-title">Images de substitution</p>
        <p class="value">{{ stats.placeholder_image }}</p>
        <p class="muted-text">Visuels issus des sources de remplacement.</p>
    </div>
    <div class="surface reveal" data-delay="160">
        <p class="eyebrow">Fiches techniques</p>
        <p class="surface-title">PDF téléchargés</p>
        <p class="value">{{ datasheet_downloaded_count }}</p>
        <p class="muted-text">Fiches PDF déjà associées aux produits.</p>
    </div>
</section>

<section class="surface reveal" data-delay="180">
    <div class="surface-header">
        <div>
            <p class="eyebrow">Management IA</p>
            <h2 class="surface-title">Liste exhaustive des produits</h2>
        </div>
        <span class="pill">{{ catalog_total }} produits</span>
    </div>
    <form method="get" class="form-grid filter-panel" style="margin:0 0 0.75rem; align-items:end;">
        <div class="field">
            <label for="catalog_query">Recherche rapide</label>
            <input
                id="catalog_query"
                type="search"
                name="catalog_query"
                class="form-control"
                placeholder="Nom, SKU, reference, code-barres"
                value="{{ catalog_query }}"
            >
        </div>
        <div class="field">
            <label for="catalog_page_size">Produits par page</label>
            <select id="catalog_page_size" name="catalog_page_size" class="form-control">
                {% for size in catalog_page_sizes %}
                    <option value="{{ size }}"{% if size == catalog_page_size %} selected{% endif %}>
                        {{ size }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="field" style="gap:0.45rem;">
            <span class="muted-text" style="font-weight:600;">Filtres rapides</span>
            <label style="display:flex; align-items:center; gap:0.5rem;">
                <input type="checkbox" name="catalog_missing_description" value="1"{% if catalog_missing_description %} checked{% endif %}>
                Sans description
            </label>
            <label style="display:flex; align-items:center; gap:0.5rem;">
                <input type="checkbox" name="catalog_missing_image" value="1"{% if catalog_missing_image %} checked{% endif %}>
                Sans image
            </label>
            <label style="display:flex; align-items:center; gap:0.5rem;">
                <input type="checkbox" name="catalog_placeholder_image" value="1"{% if catalog_placeholder_image %} checked{% endif %}>
                Image de substitution
            </label>
        </div>
        <button type="submit" class="btn secondary">Filtrer</button>
        {% if catalog_query or catalog_missing_description or catalog_missing_image or catalog_placeholder_image %}
            <a class="btn ghost" href="{% url 'inventory:product_bot' %}">Réinitialiser</a>
        {% endif %}
    </form>
    <div class="filter-summary">
        <span class="muted-text">Filtres actifs :</span>
        {% if catalog_query %}
            <span class="pill">Recherche: "{{ catalog_query }}"</span>
        {% endif %}
        {% if catalog_missing_description %}
            <span class="pill">Sans description</span>
        {% endif %}
        {% if catalog_missing_image %}
            <span class="pill">Sans image</span>
        {% endif %}
        {% if catalog_placeholder_image %}
            <span class="pill">Image de substitution</span>
        {% endif %}
        <span class="pill">{{ catalog_page_size }} / page</span>
    </div>
    <div class="ia-table">
        <div class="ia-table-header">
            <span>Référence</span>
            <span>Nom</span>
            <span>Score IA</span>
            <span>Description</span>
            <span>Image</span>
            <span>Actions IA</span>
            <span>Fiche technique</span>
            <span>Catégorie</span>
            <span>Online</span>
        </div>
        <div class="ia-table-scroll">
            {% for product in catalog_products %}
                <div class="ia-table-row" id="product-{{ product.id }}" data-product-row="{{ product.id }}">
                    <div class="ia-table-cell" data-label="Référence">
                        <strong>{{ product.sku }}</strong>
                    </div>
                    <div class="ia-table-cell muted-text" data-label="Nom">{{ product.name }}</div>
                    <div class="ia-table-cell" data-label="Score IA">
                        {% if product.quality_report %}
                            <span class="pill">{{ product.quality_report.score }}/{{ product.quality_report.max_score }}</span>
                        {% else %}
                            <span class="pill">N/A</span>
                        {% endif %}
                    </div>
                    <div class="ia-table-cell" data-label="Description">
                        <div class="muted-text" style="max-width:260px;">
                            {% if product.description %}
                                {{ product.description|truncatechars:90 }}
                            {% else %}
                                <span class="pill">Aucune description</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="ia-table-cell" data-label="Image">
                        <div class="ia-actions">
                            <div style="display:flex; align-items:center; gap:0.5rem;">
                            {% if product.image %}
                                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="ia-thumb" loading="lazy" decoding="async">
                                {% if product.image_is_placeholder %}
                                    <span class="pill">substitution</span>
                                {% endif %}
                            {% else %}
                                <div class="ia-thumb placeholder">N/A</div>
                            {% endif %}
                            </div>
                            {% if product.pending_image %}
                                <div class="ia-image-review">
                                    <img src="{{ product.pending_image.url }}" alt="Aperçu IA {{ product.name }}" class="ia-thumb pending" loading="lazy" decoding="async">
                                    <span class="pill">aperçu</span>
                                    <form method="post" style="margin:0;" data-focus-form>
                                        {% csrf_token %}
                                        <input type="hidden" name="product_id" value="{{ product.id }}">
                                        <button type="submit" name="bot_action" value="validate_image" class="btn secondary" style="padding:0.3rem 0.55rem; font-size:0.8rem;">Valider</button>
                                    </form>
                                    <form method="post" style="margin:0;" data-focus-form>
                                        {% csrf_token %}
                                        <input type="hidden" name="product_id" value="{{ product.id }}">
                                        <button type="submit" name="bot_action" value="discard_image" class="btn ghost" style="padding:0.3rem 0.55rem; font-size:0.8rem;">Refuser</button>
                                    </form>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="ia-table-cell ia-table-actions" data-label="Actions IA">
                        <div class="ia-action-group">
                            <span class="ia-action-label">Description</span>
                            <div class="ia-action-row">
                                <form method="post" style="margin:0;" data-focus-form>
                                    {% csrf_token %}
                                    <input type="hidden" name="product_id" value="{{ product.id }}">
                                    <button type="submit" name="bot_action" value="generate_description" class="btn ghost" style="padding:0.35rem 0.6rem; font-size:0.85rem;">Générer</button>
                                </form>
                                <form method="post" style="margin:0;" data-focus-form>
                                    {% csrf_token %}
                                    <input type="hidden" name="product_id" value="{{ product.id }}">
                                    <button type="submit" name="bot_action" value="force_description" class="btn secondary" style="padding:0.35rem 0.6rem; font-size:0.85rem;">Remplacer</button>
                                </form>
                            </div>
                        </div>
                        <div class="ia-action-group">
                            <span class="ia-action-label">Image</span>
                            <div class="ia-action-row">
                                <form method="post" style="margin:0;" data-focus-form>
                                    {% csrf_token %}
                                    <input type="hidden" name="product_id" value="{{ product.id }}">
                                    <button type="submit" name="bot_action" value="generate_image" class="btn ghost" style="padding:0.35rem 0.6rem; font-size:0.85rem;">Générer</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="ia-table-cell" data-label="Fiche technique">
                        {% if product.datasheet_pdf %}
                            <a class="btn ghost" href="{{ product.datasheet_pdf.url }}" target="_blank" rel="noopener" download style="padding:0.35rem 0.6rem; font-size:0.85rem;">Télécharger</a>
                        {% elif product.datasheet_url %}
                            <a class="btn ghost" href="{{ product.datasheet_url }}" target="_blank" rel="noopener" style="padding:0.35rem 0.6rem; font-size:0.85rem;">Source</a>
                        {% else %}
                            <form method="post" style="margin:0;" data-focus-form>
                                {% csrf_token %}
                                <input type="hidden" name="product_id" value="{{ product.id }}">
                                <button type="submit" name="bot_action" value="datasheet_fetch_one" class="btn ghost" style="padding:0.35rem 0.6rem; font-size:0.85rem;">Télécharger</button>
                            </form>
                        {% endif %}
                    </div>
                    <form method="post" class="ia-table-cell" data-label="Catégorie" style="gap:0.5rem; margin:0;" data-focus-form>
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <select name="category_id" class="form-control" style="min-width:150px;">
                            {% for category in catalog_categories %}
                                <option value="{{ category.id }}"{% if category.id == product.category_id %} selected{% endif %}>
                                    {{ category.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <button type="submit" name="bot_action" value="update_category" class="btn secondary" style="padding:0.35rem 0.6rem; font-size:0.85rem;">Mettre à jour</button>
                        <button type="submit" name="bot_action" value="auto_category_one" class="btn ghost" style="padding:0.35rem 0.6rem; font-size:0.85rem;">IA Mistral</button>
                    </form>
                    <form method="post" class="ia-table-cell" data-label="Online" style="gap:0.5rem; margin:0;" data-focus-form>
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <input type="hidden" name="is_online" value="{% if product.is_online %}0{% else %}1{% endif %}">
                        <button type="submit" name="bot_action" value="toggle_online" class="btn {% if product.is_online %}secondary{% else %}ghost{% endif %}" style="padding:0.35rem 0.6rem; font-size:0.85rem;">
                            {% if product.is_online %}✅ En ligne{% else %}⛔ Hors ligne{% endif %}
                        </button>
                    </form>
                </div>
            {% endfor %}
        </div>
    </div>
    {% if catalog_page_obj.paginator.num_pages > 1 %}
        <div class="pagination" style="margin-top:1rem;">
            {% if catalog_page_obj.has_previous %}
                <a class="btn ghost" href="?catalog_page=1&{{ catalog_pagination_query }}">&laquo; Début</a>
                <a class="btn ghost" href="?catalog_page={{ catalog_page_obj.previous_page_number }}&{{ catalog_pagination_query }}">Précédent</a>
            {% else %}
                <span class="btn ghost" aria-disabled="true">Début</span>
                <span class="btn ghost" aria-disabled="true">Précédent</span>
            {% endif %}
            <span class="muted-text" style="align-self:center;">
                Page {{ catalog_page_obj.number }} / {{ catalog_page_obj.paginator.num_pages }}
            </span>
            {% if catalog_page_obj.has_next %}
                <a class="btn ghost" href="?catalog_page={{ catalog_page_obj.next_page_number }}&{{ catalog_pagination_query }}">Suivant</a>
                <a class="btn ghost" href="?catalog_page={{ catalog_page_obj.paginator.num_pages }}&{{ catalog_pagination_query }}">Fin &raquo;</a>
            {% else %}
                <span class="btn ghost" aria-disabled="true">Suivant</span>
                <span class="btn ghost" aria-disabled="true">Fin</span>
            {% endif %}
        </div>
    {% endif %}
    <script>
        (() => {
            const key = "iaFocusProduct";
            document.querySelectorAll("[data-focus-form]").forEach((form) => {
                form.addEventListener("submit", () => {
                    const input = form.querySelector('input[name="product_id"]');
                    if (input && input.value) {
                        sessionStorage.setItem(key, input.value);
                    }
                });
            });
            const focusId = sessionStorage.getItem(key);
            if (!focusId) return;
            const target = document.getElementById(`product-${focusId}`);
            if (target) {
                target.classList.add("ia-row-focus");
                target.scrollIntoView({ block: "center", behavior: "smooth" });
                window.setTimeout(() => {
                    target.classList.remove("ia-row-focus");
                }, 2200);
            }
            sessionStorage.removeItem(key);
        })();
    </script>
</section>

<section class="surface reveal" data-delay="220">
    <div class="surface-header">
        <div>
            <p class="eyebrow">Enrichissement IA</p>
            <h2 class="surface-title">Lancer des actions ciblées</h2>
        </div>
        <span class="pill">Actions</span>
    </div>
    <p class="muted-text" style="margin:0;">
        Choisis une action selon ton besoin : un SKU unique, un lot intelligent ou une sélection personnalisée.
    </p>
</section>

<section class="split split-70">
    <div class="surface reveal" data-delay="240">
        <h2 class="surface-title">Cible unique</h2>
        <p class="muted-text" style="margin-top:0.25rem;">
            Sélectionne un SKU et choisis si le bot doit forcer la réécriture
            ou le remplacement d'image.
        </p>
        <form method="post" class="form-grid" novalidate>
            {% csrf_token %}
            <div class="field">
                {{ manual_form.product.label_tag }}
                {{ manual_form.product }}
                {% for error in manual_form.product.errors %}
                    <p class="muted-text" style="color: var(--danger);">{{ error }}</p>
                {% endfor %}
            </div>
            <div class="field" style="display:flex; flex-direction:column; gap:0.35rem;">
                <p class="muted-text" style="margin:0;">Assets à générer</p>
                {{ manual_form.assets }}
            </div>
            <div class="field" style="display:flex; flex-direction:column; gap:0.35rem;">
                <label style="display:flex; align-items:center; gap:0.5rem;">
                    {{ manual_form.force_description }}
                    {{ manual_form.force_description.label }}
                </label>
                <label style="display:flex; align-items:center; gap:0.5rem;">
                    {{ manual_form.force_image }}
                    {{ manual_form.force_image.label }}
                </label>
                <label style="display:flex; align-items:center; gap:0.5rem;">
                    {{ manual_form.force_techsheet }}
                    {{ manual_form.force_techsheet.label }}
                </label>
                <label style="display:flex; align-items:center; gap:0.5rem;">
                    {{ manual_form.force_pdf }}
                    {{ manual_form.force_pdf.label }}
                </label>
                <label style="display:flex; align-items:center; gap:0.5rem;">
                    {{ manual_form.force_videos }}
                    {{ manual_form.force_videos.label }}
                </label>
                <label style="display:flex; align-items:center; gap:0.5rem;">
                    {{ manual_form.force_blog }}
                    {{ manual_form.force_blog.label }}
                </label>
                {% if manual_form.force_description.errors %}
                    <p class="muted-text" style="color: var(--danger);">
                        {{ manual_form.force_description.errors.0 }}
                    </p>
                {% endif %}
            </div>
            <button type="submit" name="bot_action" value="single" class="btn">Lancer le bot sur ce produit</button>
        </form>
    </div>
    <div class="surface surface-muted reveal" data-delay="260">
        <h2 class="surface-title">Lot intelligent</h2>
        <p class="muted-text" style="margin-top:0.25rem;">
            Appliquer à un lot de produits pour rattraper les fiches incomplètes.
            Laisse le champ vide pour toucher tous les produits filtrés.
        </p>
        <form method="post" class="form-grid" novalidate>
            {% csrf_token %}
            <div class="field">
                {{ bulk_form.limit.label_tag }}
                {{ bulk_form.limit }}
                {% for error in bulk_form.limit.errors %}
                    <p class="muted-text" style="color: var(--danger);">{{ error }}</p>
                {% endfor %}
            </div>
            <div class="field" style="display:flex; flex-direction:column; gap:0.35rem;">
                <p class="muted-text" style="margin:0;">Assets à générer</p>
                {{ bulk_form.assets }}
            </div>
            <div class="field" style="display:flex; flex-direction:column; gap:0.35rem;">
                <label style="display:flex; align-items:center; gap:0.5rem;">
                    {{ bulk_form.force_description }}
                    {{ bulk_form.force_description.label }}
                </label>
                <label style="display:flex; align-items:center; gap:0.5rem;">
                    {{ bulk_form.force_image }}
                    {{ bulk_form.force_image.label }}
                </label>
                <label style="display:flex; align-items:center; gap:0.5rem;">
                    {{ bulk_form.force_techsheet }}
                    {{ bulk_form.force_techsheet.label }}
                </label>
                <label style="display:flex; align-items:center; gap:0.5rem;">
                    {{ bulk_form.force_pdf }}
                    {{ bulk_form.force_pdf.label }}
                </label>
                <label style="display:flex; align-items:center; gap:0.5rem;">
                    {{ bulk_form.force_videos }}
                    {{ bulk_form.force_videos.label }}
                </label>
                <label style="display:flex; align-items:center; gap:0.5rem;">
                    {{ bulk_form.force_blog }}
                    {{ bulk_form.force_blog.label }}
                </label>
            </div>
            <button type="submit" name="bot_action" value="batch" class="btn secondary">Envoyer le lot</button>
        </form>
    </div>
</section>

<section class="surface reveal" data-delay="300">
    <div class="surface-header">
        <div>
            <p class="eyebrow">Automatisation & donnees</p>
            <h2 class="surface-title">Enrichissement technique & categories</h2>
        </div>
        <span class="pill">Ops</span>
    </div>
    <p class="muted-text" style="margin:0;">
        Centralise la recuperation des fiches techniques et l'attribution automatique des categories.
    </p>
</section>

<section class="grid auto-2">
    <div class="surface surface-muted reveal" data-delay="320">
        <div class="surface-header">
            <div>
                <p class="eyebrow">Hikvision & Dahua</p>
                <h2 class="surface-title">Fiches techniques PDF</h2>
            </div>
            <span class="pill">PDF</span>
        </div>
        <p class="muted-text" style="margin:0 0 0.75rem;">
            Recherche via Serper (prioritaire) puis Google CSE en secours, puis telecharge les fiches techniques PDF pour Hikvision et/ou Dahua.
            Deduplication par modele pour limiter le quota.
        </p>
        <form method="post" class="form-grid" novalidate>
            {% csrf_token %}
            <div class="field">
                {{ datasheet_form.brand_scope.label_tag }}
                {{ datasheet_form.brand_scope }}
                {% for error in datasheet_form.brand_scope.errors %}
                    <p class="muted-text" style="color: var(--danger);">{{ error }}</p>
                {% endfor %}
            </div>
            <div class="field">
                {{ datasheet_form.limit.label_tag }}
                {{ datasheet_form.limit }}
                {% for error in datasheet_form.limit.errors %}
                    <p class="muted-text" style="color: var(--danger);">{{ error }}</p>
                {% endfor %}
            </div>
            <div class="field">
                {{ datasheet_form.prefer_lang.label_tag }}
                {{ datasheet_form.prefer_lang }}
                {% for error in datasheet_form.prefer_lang.errors %}
                    <p class="muted-text" style="color: var(--danger);">{{ error }}</p>
                {% endfor %}
            </div>
            <div class="field" style="display:flex; flex-direction:column; gap:0.35rem;">
                <label style="display:flex; align-items:center; gap:0.5rem;">
                    {{ datasheet_form.force }}
                    {{ datasheet_form.force.label }}
                </label>
                {% if not datasheet_configured %}
                    <p class="muted-text" style="margin:0;">Ajoutez SERPER_API_KEY ou GOOGLE_CSE_API_KEY + GOOGLE_CSE_CX.</p>
                {% endif %}
            </div>
            <div class="field" style="display:flex; align-items:flex-end;">
                <button type="submit" name="bot_action" value="datasheet_fetch" class="btn">
                    Lancer le telechargement
                </button>
            </div>
        </form>
        {% if datasheet_result %}
            <div style="margin-top:0.85rem;">
                <p class="muted-text" style="margin:0 0 0.35rem;">
                    Modeles: {{ datasheet_result.models }} · Produits: {{ datasheet_result.products }}
                    · OK: {{ datasheet_result.updated }} · Ignores: {{ datasheet_result.skipped }}
                    · Erreurs: {{ datasheet_result.failed }}
                </p>
                {% if datasheet_result.errors %}
                    <div style="border:1px solid var(--border); border-radius:14px; padding:0.6rem; max-height:220px; overflow:auto;">
                        <div style="display:grid; gap:0.5rem;">
                            {% for item in datasheet_result.errors %}
                                <div style="display:flex; justify-content:space-between; gap:0.75rem; align-items:center; padding:0.45rem 0.6rem; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,0.02);">
                                    <div>
                                        <strong>{{ item.model|default:"Modele inconnu" }}</strong>
                                        {% if item.product_id %}
                                            <div class="muted-text">Produit {{ item.product_id }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="muted-text" style="text-align:right;">{{ item.error }}</div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </div>

    <div class="surface surface-muted reveal" data-delay="340">
        <div class="surface-header">
            <div>
                <p class="eyebrow">Categories</p>
                <h2 class="surface-title">Attribution automatique</h2>
            </div>
            <span class="pill">Auto</span>
        </div>
        <p class="muted-text" style="margin:0 0 0.75rem;">
            Lance l'attribution automatique des categories pour les produits.
        </p>
        <form method="post" class="form-grid" novalidate>
            {% csrf_token %}
            <div class="field">
                {{ category_form.limit.label_tag }}
                {{ category_form.limit }}
                {% for error in category_form.limit.errors %}
                    <p class="muted-text" style="color: var(--danger);">{{ error }}</p>
                {% endfor %}
            </div>
            <div class="field">
                {{ category_form.rules_path.label_tag }}
                {{ category_form.rules_path }}
                {% for error in category_form.rules_path.errors %}
                    <p class="muted-text" style="color: var(--danger);">{{ error }}</p>
                {% endfor %}
            </div>
            <div class="field" style="display:flex; flex-direction:column; gap:0.35rem;">
                <label style="display:flex; align-items:center; gap:0.5rem;">
                    {{ category_form.apply_all }}
                    {{ category_form.apply_all.label }}
                </label>
                <label style="display:flex; align-items:center; gap:0.5rem;">
                    {{ category_form.dry_run }}
                    {{ category_form.dry_run.label }}
                </label>
                <label style="display:flex; align-items:center; gap:0.5rem;">
                    {{ category_form.use_ai }}
                    {{ category_form.use_ai.label }}
                </label>
                {% if not category_ai_available %}
                    <p class="muted-text" style="margin:0;">Mistral n'est pas configure.</p>
                {% endif %}
            </div>
            <div class="field" style="display:flex; align-items:flex-end;">
                <button type="submit" name="bot_action" value="auto_category" class="btn">Lancer la categorisation</button>
            </div>
        </form>
        {% if category_result %}
            <div style="margin-top:0.85rem;">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:0.75rem; flex-wrap:wrap; margin-bottom:0.45rem;">
                    <p class="muted-text" style="margin:0;">
                        {{ category_mode_label }} : {{ category_result.updated }} ajoutes, {{ category_result.skipped }} inchanges, {{ category_result.unmatched }} sans correspondance.
                    </p>
                    <div style="display:flex; gap:0.35rem; flex-wrap:wrap; justify-content:flex-end;">
                        <span class="pill">{{ category_result.evaluated }} evalues</span>
                        {% if category_result.ai_used %}
                            <span class="pill">IA: {{ category_result.ai_used }}</span>
                        {% endif %}
                    </div>
                </div>
                <p class="muted-text" style="margin:0 0 0.5rem;">
                    Cible : {{ category_scope_label }}{% if category_limit_value %} · Limite {{ category_limit_value }}{% endif %}
                </p>
                {% if category_evaluations %}
                    <div style="border:1px solid var(--border); border-radius:14px; padding:0.6rem; max-height:300px; overflow:auto;">
                        <div style="display:grid; gap:0.5rem;">
                            {% for item in category_evaluations %}
                                <div style="display:grid; grid-template-columns:1fr auto; gap:0.75rem; align-items:center; padding:0.55rem 0.65rem; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,0.02);">
                                    <div>
                                        <strong>{{ item.sku }}</strong>
                                        <div class="muted-text" style="margin-top:0.15rem;">{{ item.name }}</div>
                                        <div class="muted-text" style="margin-top:0.15rem;">Categorie actuelle : {{ item.current_category }}</div>
                                    </div>
                                    <div style="display:flex; gap:0.35rem; flex-wrap:wrap; justify-content:flex-end;">
                                        {% if item.status == "updated" %}
                                            <span class="pill">{% if category_is_dry_run %}proposee{% else %}ajoutee{% endif %}</span>
                                            <span class="pill">{{ item.suggested_category }}</span>
                                        {% elif item.status == "skipped" %}
                                            <span class="pill">inchanges</span>
                                            <span class="pill">{{ item.suggested_category }}</span>
                                        {% else %}
                                            <span class="pill">sans correspondance</span>
                                        {% endif %}
                                        {% if item.source %}
                                            <span class="pill">{{ item.source }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% if category_evaluations_truncated %}
                        <p class="muted-text" style="margin:0.35rem 0 0;">Affichage limite a 200 produits.</p>
                    {% endif %}
                {% else %}
                    <p class="muted-text" style="margin:0;">Aucun produit evalue.</p>
                {% endif %}
            </div>
        {% endif %}
    </div>
</section>

<section class="surface surface-muted reveal" data-delay="350">
    <div class="surface-header">
        <div>
            <p class="eyebrow">Fonctionnement</p>
            <h2 class="surface-title">Mistral + images produits</h2>
        </div>
        <span class="pill">IA</span>
    </div>
    <p class="lead" style="margin:0 0 0.75rem;">
        Le bot utilise Mistral pour générer un texte en deux phrases max
        et récupère un visuel via la variable
        <code>PRODUCT_BOT_IMAGE_URL_TEMPLATE</code> (utilise de préférence
        <code>{reference}</code>). Choisis un produit, force le regroupement
        désiré ou lance un lot.
    </p>
    <p class="muted-text" style="margin:0;">
        Chaque action est mise en file via Celery (assure-toi d'avoir un worker
        actif) et peut être filtrée par description et image existantes.
    </p>
</section>

<section class="surface surface-muted reveal" data-delay="360">
    <div class="surface-header">
        <div>
            <p class="eyebrow">File IA</p>
            <h2 class="surface-title">Dernières activités</h2>
        </div>
        <span class="pill">{{ queue_pending }} en attente</span>
    </div>
    {% if recent_jobs %}
        <div class="stack" style="margin-top:0.5rem;">
            {% for job in recent_jobs %}
                <article class="stack-item" style="padding:0.65rem 0; border-bottom:1px solid var(--border);">
                    <div style="display:flex; justify-content:space-between; gap:1rem; align-items:flex-start;">
                        <div>
                            <strong>{{ job.product.sku|default:"Produit supprimé" }}</strong>
                            {% if job.product %}
                                <p class="muted-text" style="margin:0;">{{ job.product.name }}</p>
                            {% endif %}
                        </div>
                        <div class="muted-text" style="text-align:right;">
                            <span class="pill">{{ job.get_status_display }}</span>
                            <p style="margin:0;" class="muted-text">{{ job.created_at|date:"d/m H:i" }}</p>
                        </div>
                    </div>
                    <p class="muted-text" style="margin:0.25rem 0 0;">
                        Description : <strong>{% if job.description_changed %}oui{% else %}non{% endif %}</strong>
                        · Image : <strong>{% if job.image_changed %}oui{% else %}non{% endif %}</strong>
                    </p>
                    {% if job.last_message %}
                        <p class="muted-text" style="margin:0.35rem 0 0;">{{ job.last_message }}</p>
                    {% endif %}
                </article>
            {% endfor %}
        </div>
    {% else %}
        <p class="muted-text" style="margin:0;">Aucune activité récente.</p>
    {% endif %}
</section>

<section class="grid auto-3">
    <div class="surface surface-muted reveal" data-delay="380">
        <div class="surface-header">
            <div>
                <p class="eyebrow">Sans description</p>
                <h2 class="surface-title">Quelques produits</h2>
            </div>
        </div>
        {% if missing_description_products %}
            <ul class="stack" style="list-style:none; margin:0; padding:0;">
                {% for product in missing_description_products %}
                    <li style="display:flex; justify-content:space-between; padding:0.35rem 0; border-bottom:1px solid var(--border);">
                        <span>{{ product.sku }}</span>
                        <span class="muted-text">{{ product.name }}</span>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="muted-text">Toutes les descriptions sont renseignées.</p>
        {% endif %}
    </div>
    <div class="surface surface-muted reveal" data-delay="400">
        <div class="surface-header">
            <div>
                <p class="eyebrow">Sans visuel</p>
                <h2 class="surface-title">Suivi rapide</h2>
            </div>
        </div>
        {% if missing_image_products %}
            <ul class="stack" style="list-style:none; margin:0; padding:0;">
                {% for product in missing_image_products %}
                    <li style="display:flex; justify-content:space-between; padding:0.35rem 0; border-bottom:1px solid var(--border);">
                        <span>{{ product.sku }}</span>
                        <span class="muted-text">{{ product.name }}</span>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="muted-text">Tous les produits ont un visuel.</p>
        {% endif %}
    </div>
    <div class="surface surface-muted reveal" data-delay="410">
        <div class="surface-header">
            <div>
                <p class="eyebrow">Substitution</p>
                <h2 class="surface-title">Visuels a revoir</h2>
            </div>
        </div>
        {% if placeholder_image_products %}
            <ul class="stack" style="list-style:none; margin:0; padding:0;">
                {% for product in placeholder_image_products %}
                    <li style="display:flex; justify-content:space-between; padding:0.35rem 0; border-bottom:1px solid var(--border);">
                        <span>{{ product.sku }}</span>
                        <span class="muted-text">{{ product.name }}</span>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="muted-text">Aucun visuel de substitution.</p>
        {% endif %}
    </div>
    <div class="surface surface-muted reveal" data-delay="420">
        <div class="surface-header">
            <div>
                <p class="eyebrow">Fiches techniques</p>
                <h2 class="surface-title">Telechargees</h2>
            </div>
            <span class="pill">{{ datasheet_downloaded_count }}</span>
        </div>
        {% if datasheet_products %}
            <ul class="stack" style="list-style:none; margin:0; padding:0;">
                {% for product in datasheet_products %}
                    <li style="display:flex; justify-content:space-between; align-items:center; padding:0.35rem 0; border-bottom:1px solid var(--border); gap:0.6rem;">
                        <div>
                            <span>{{ product.sku }}</span>
                            <span class="muted-text" style="margin-left:0.4rem;">{{ product.name }}</span>
                        </div>
                        <div style="display:flex; gap:0.35rem; flex-wrap:wrap; justify-content:flex-end;">
                            {% if product.datasheet_pdf %}
                                <a class="btn ghost" href="{{ product.datasheet_pdf.url }}" target="_blank" rel="noopener">PDF</a>
                            {% endif %}
                            {% if product.datasheet_url %}
                                <a class="btn ghost" href="{{ product.datasheet_url }}" target="_blank" rel="noopener">Source</a>
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="muted-text">Aucune fiche technique telechargee.</p>
        {% endif %}
    </div>
</section>
{% endblock %}
